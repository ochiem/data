<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>???</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/css/uikit.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <link id="favicon" rel="icon" type="image/png" >
    <script src="config_multipairv3.js"></script>
    <style>
        .uk-container { width: 96%; max-width: none; }
        .status-active { color: green; }
        .status-inactive { color: red; }
        .sort-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
        /* Memaksa warna link untuk CEX */
        .uk-link {
            color: inherit !important;  /* Memastikan warna link mengikuti warna induk */
        }
        a {
            text-decoration: none; /* Menghapus garis bawah */
            color: inherit;        /* Menggunakan warna teks elemen induk */
        }
        /* Memaksa warna status aktif */
        .status-active {
            color: inherit !important;  /* Warna aktif mengikuti warna yang ditentukan */
        }
        img:hover {
                opacity:1;
                transform: scale(1.8); /* You can adjust the scale factor as needed */
            }
        img{
            margin: 1.5px;
        }    
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 10px;
            margin-top: 10px;  /* Ubah margin top menjadi lebih kecil */
        }

        #progress-bar {
            height: 14px;  /* Mengurangi tinggi bar progress menjadi 10px */
            width: 0%;
            /* background-color: #4caf50; */
            border-radius: 5px; /* Untuk membuat ujung bar lebih melengkung */
            position: relative;
        }

        #progress-bar span {
            color: white;
            text-align: center;
            line-height: 10px;  /* Menyesuaikan tinggi bar agar teks tetap berada di tengah */
            display: block;
            font-weight: bold;
        }

        /* Tambahkan scroll untuk tabel */
        .uk-overflow-auto {
            overflow-x: auto; /* Scroll horizontal jika diperlukan */
            max-height: 800px; /* Batasi tinggi untuk memunculkan scroll */
            background-color: white; 
        }

        .uk-table tbody td {
            font-size: 11.5px;
            border: 0.85px solid #ddd;
            padding: 6px;
            white-space: nowrap;
        }
        .uk-background{
            background-color: lightgray;
        }
        .merah{
            font-weight: bold;
            color: rgb(250, 249, 249) !important;
            background-color:#eb6464!important;
        }
        .buy {
            color:#05a705;
            font-weight:bolder;
        }
        .sell {
            color:#ea0c0c;
            font-weight:bolder;
        }
        .ijo {
            color: black !important;
            font-weight: bolder;
        }
        .error{
            color: #fafafa!important;
            background-color: #f39999!important;
        }
        .errorrestapi{
            background-color: #f6f2f1!important;
        }
       
        .sinyal-item {
            margin-bottom: 2px;  /* Jarak antar sinyal */
            padding-bottom: 1px;  /* Jarak dari garis bawah ke teks */
            border-bottom: 1px solid #ccc;  /* Garis bawah sebagai pembatas */
        }
        body{
            font-family: Arial, Helvetica, sans-serif;
            padding: 1px;
            /* background-image: linear-gradient(#cffad4, #fefefe, #f3f7f4); */
            color: #0f0f0f;
        }
        .icon-wrapper {
            display: inline-flex;          /* Menjadikan elemen inline fleksibel */
            justify-content: center;       /* Pusatkan gambar secara horizontal */
            align-items: center;           /* Pusatkan gambar secara vertikal */
            margin: 10px;
            transform: scale(1.6);              /* Tinggi ikon */
            background-color: #f97aa8;     /* Warna latar belakang */
            border-radius: 35%;            /* Membuat bentuk lingkaran */
            cursor: pointer;               /* Ubah kursor menjadi tangan saat diklik */
            transition: background-color 0.3s ease; /* Animasi untuk efek hover */
        }

    </style>
    
</head>
<body>
<div class="uk-container uk-margin-small-top">
        <div class="uk-flex uk-flex-between uk-grid-small" uk-grid style="flex: 1;">
            <!-- Bagian Kiri (Form) -->
            <div class="uk-width-auto">
                <h2 id="judul" class="uk-margin-remove" style="font-size: 30px; text-align:center;">
                    MULTIPAIR V3 <label id="namachain"></label> :: SCANNER &nbsp;
                </h2>
                <img class="icon" id="LoadDataBtn" title="LOAD DATA TOKEN" width="30px" src="https://png.pngtree.com/png-clipart/20230815/original/pngtree-database-sync-icon-icon-symbol-data-vector-picture-image_10830033.png" />
                <img class="icon" id="SettingModal" title="CONFIG SCANNER" width="30px" src="https://cdn-icons-png.flaticon.com/512/1170/1170635.png" />
                <img class="icon" id="UpdateWalletCEX" title="UPDATE WALLET CEX" width="30px" src="https://images.freeimages.com/fic/images/icons/2770/ios_7_icons/512/wallet.png" />
                <a href="manajemen_aset.html" target="_blank">
                    <img class="icon" id="Modal" title="MANAJEMEN ASSET" width="30px" src="https://cdn-icons-png.flaticon.com/512/1194/1194711.png" />
                </a>
                <a href="multipair.html" target="_blank">
                    <img class="icon" id="MasterData" title="SETTING DATA" width="30px" src="https://cdn-icons-png.flaticon.com/128/3934/3934107.png" />
                </a>
                <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">
                    <img class="icon" id="BukaKunci" title="BUKA AKSES" width="30px" src="https://cdn-icons-png.flaticon.com/512/9921/9921748.png" />
                </a>
                <img class="icon" id="reload" title="REFRESH PAGE" width="30px" src="https://cdn-icons-png.flaticon.com/512/2546/2546705.png" />
              
                <span id="chain-links-container"></span>        
                <h6 id="config" class="uk-margin-remove uk-text-left uk-text-danger">---</h6>        
            </div>
    
            <!-- Bagian Kanan (Konten Lainnya) -->
            <div class="uk-width-expand uk-margin-small-top">
                <form id="cryptoForm" style=" width: 96%;">
                        <div class="dex-group  uk-grid-small uk-flex uk-flex-between" uk-grid>
                           
                            <div class="uk-width-auto uk-flex uk-flex-middle uk-background-muted uk-text-small">
                                <b><span class="uk-text-secondary uk-text-medium">INFO: &nbsp;</span></b>
                                <b><span class="uk-text-primary uk-text-medium" id="infoAPP">???</span></b>&nbsp; &nbsp; &nbsp;
                            </div> 
                                  
                            <!-- Kolom untuk CEX -->
                            <div class="uk-width-auto uk-flex uk-flex-middle">
                                <div id="cex-options" class="uk-form-controls" style="display: flex;">
                                    <!-- Radio button CEX akan di-generate di sini -->
                                </div>
                            </div>
                            <!-- Kolom untuk PAIR -->
                            <div class="uk-width-auto uk-flex uk-flex-middle">
                                <b><span class="uk-text-secondary uk-text-medium">PAIR&nbsp;</span></b> <span id="tokenCount" class="uk-text-danger uk-text-bolder" > </span>&nbsp;:
                                <div id="dexpair-options" class="uk-form-controls" style="display: flex;">
                                    <!-- Radio button PAIR DEX akan di-generate di sini -->
                                </div> 
                            </div>

                            <!-- Kolom untuk DEX -->
                            <div class="uk-width-auto uk-flex uk-flex-middle">
                                <div id="dex-options" class="uk-form-controls" style="display: flex;">
                                    <!-- Radio button DEX akan di-generate di sini -->
                                </div>
                                &nbsp;&nbsp;
                                &nbsp;&nbsp;
                                <button type="button" id="startSCAN" style="display: none;" class="uk-button uk-button-secondary uk-button-small">START</button>
                                <button type="button" id="stopSCAN" style="display: none;" class="uk-button uk-button-danger uk-button-small">STOP</button>                                

                            </div>
        
                        </div>
                </form>
            </div>
        </div>

    <!-- Modal UIKIT -->
    <div id="modal-setting" class="uk-modal-full" uk-modal>
        <div class="uk-modal-dialog">
            <button class="uk-modal-close-full uk-close-large" type="button" uk-close></button>
            <div class="uk-modal-header">
                <h2 class="uk-modal-title">:: SETTING DEX CHECKER</h2>
               
            </div>
            <div class="uk-modal-body">
                <form> 
                    <!-- Grid UIkit untuk 2 kolom -->
                    <div class="uk-grid-small" uk-grid>
                        
                        <div class="uk-width-1-2">
                            
                            <!-- Kolom pertama -->
                            <div class="uk-card uk-card-default uk-card-body">
                                <h3 style="text-align: center; color: #1317e1;">:: SETINGAN PERMODALAN</h3>
                                <div id="modal-container"></div>                                
                            </div>
                        </div>
                        <div class="uk-width-1-2">
                            <!-- Kolom kedua -->
                            <div class="uk-card uk-card-default uk-card-body">
                                <h3 style="text-align: center; margin: 12px 0px; color: #1317e1;">:: SETINGAN SCANNER</h3>
                                <label for="pnl">NICK NAME:</label>
                                <input type="text" id="user"  class="uk-input" required>

                                <div class="uk-flex uk-flex-middle uk-margin ">
                                    <!-- <div style="display: none;"> -->
                                       <div>
                                           <label for="jeda-time-group" class="uk-text-danger">KOIN/GRUP : </label>
                                           <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="7" name="koin-group"> 7</label>                                          
                                           <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="6"  name="koin-group"> 6</label> 
                                           <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="5" checked name="koin-group"> 5</label>
                                           <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="4"  name="koin-group"> 4</label>  
                                        </div>
                                    </div>
                                <div class="uk-flex uk-flex-middle uk-margin ">
                                       <div>
                                            <label for="SPEEDSCAN" class="uk-text-danger">WAKTU TUNGGU</label>
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="2"  name="waktu-tunggu"> NORMAL </label>
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1.5" name="waktu-tunggu"> MEDIUM </label>
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1" name="waktu-tunggu"> FAST </label>
                                        </div>
                                   </div>
                                <div>
                                </div>
                                
                                <div class="uk-flex uk-flex-middle uk-margin ">
                                 <!-- <div style="display: none;"> -->
                                    <div>
                                        <label for="jeda-koin" class="uk-text-warning">FILTER PNL</label><br/>
                                        <input class="uk-input" type="number" id="inFilterPNL" value="0" name="filterpnl" >         
                                    </div>
                                    <div>
                                        <label for="jeda-time-group" class="uk-text-danger">JEDA / GROUP {1500}</label><br/>
                                        <input class="uk-input" id="jeda-time-group" type="number" value="1500" name="jeda-time-group" >
                                    </div>
                                    <div>
                                        <label for="jeda-koin" class="uk-text-primary">JEDA / KOIN {300}</label><br/>
                                        <input class="uk-input" type="number" id="jeda-koin" value="300" name="jeda-koin" > 
                                    </div>
                                </div>

                                    <div>
                                        <label for="walletMeta" class="uk-text-danger">WALLET METAMASK</label><br />
                                        <input class="uk-input" type="text" id="walletMeta" name="walletMeta" >
                                    </div>
                                <div>                                    
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tombol untuk menutup modal -->
                    <p class="uk-text-right">
                        <button class="uk-button uk-button-default uk-modal-close" type="button">Tutup</button>
                        <button type="button" id="save-config" class="uk-button uk-button-primary">SIMPAN</button>  
                    </p>                   
                </form>
            </div>
        </div>
    </div>

    <div>
        <!-- Bagian untuk menampilkan sinyal DEX -->
        <div class="uk-text uk-text-small  uk-margin-small-top " id="sinyal-container" style="background-color: #fff;">
            <!-- Sinyal DEX akan dimuat di sini -->
        </div>
        <div class="uk-grid-small uk-flex uk-flex-middle  uk-margin-small-top" uk-grid>
            <!-- Judul dan Jumlah Token -->
            <div class="uk-width-expand">
                <h4 class="uk-heading-line uk-margin-remove" id="daftar">
                    <span style="font-size:medium; font-weight: bolder;">DAFTAR TOKEN PAIR ::  <span id="namachain2"></span> (<span id="tokenCountALL" class="token-count">0</span>)</span>
                    
                </h4>
            </div>
           
            <!-- Pencarian -->
            <div class="uk-width-auto uk-flex uk-flex-middle">
                <span class="uk-form-label uk-text-danger uk-text-bolder">SORTING : 
                    <span class="uk-form-label uk-text-primary">
                        <input type="radio" name="toggle" checked value="opt_A"> A 
                        <input type="radio" name="toggle" value="opt_B"> Z
                        <input type="checkbox" checked id="strictFilter"> WALLET CEX
                        </span>  
                </span>
                &nbsp;&nbsp;&nbsp;
                <input type="text" id="searchInput" class="uk-input uk-form-small uk-form-primary uk-form-width-small" placeholder="Cari di tabel...">
            </div>
        </div>
    </div>

    <div id="progress-container" style="width: 100%; background-color: #f3f3f3; border-radius: 10px; margin-top: 10px;">
        <div id="progress-bar" style="height: 14px; width: 0%; background-color: #4caf50; border-radius: 5px;">
            <span id="progress-text" style="color: white; font-size: 12px; text-align: center; line-height: 10px; display: block; font-weight: bold;">0%</span>
        </div>
    </div>
    <div id="progress" style="font-size: 14px; font-weight: bold; margin-top: 5px;"></div>
    
    <div class="uk-overflow-auto uk-margin-small-top">
        <table class="uk-table uk-table-hover uk-table-small uk-table-striped">
            <thead class="table-header">
                <tr>
                    <!-- Kolom-kolom header akan ditambahkan secara dinamis -->
                </tr>
            </thead>
            <tbody id="dataTableBody">
                <!-- Baris-baris data akan ditambahkan secara dinamis -->
            </tbody>
        </table>
        <div id="InfoAPP" style="text-align:center; font-weight:bold; color:red;"></div>    
        <div id="InfoStatus" style="text-align:center; font-weight:bold; color:red;"></div>    
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    toastr.options = {
        "timeOut": "2000",            // Durasi munculnya toastr dalam milidetik
        "extendedTimeOut": "2000",    // Waktu tambahan saat toastr di-hover
        "closeButton": true,          // Tampilkan tombol close (opsional)
        "progressBar": true,          // Tampilkan progress bar (opsional)
        "positionClass": "toast-top-right" // Posisi toastr (ubah sesuai kebutuhan)
    };

    // Mendapatkan parameter dari URL
    const urlParams = new URLSearchParams(window.location.search);
    const chainName = urlParams.get('chain') || "bsc"; // Default ke 'bsc' jika tidak ada parameter 'chain' di URL

    // Memilih chain yang sesuai berdasarkan parameter URL
    const selectedChain = CONFIG_CHAINS[chainName] || CONFIG_CHAINS['bsc']; 

    // Mengatur konfigurasi global chain berdasarkan input dari URL
    const { Kode_Chain, Nama_Chain, URL_Chain, pairs } = selectedChain; 

    const storagePrefix = "MULTIPAIR_V3_" + Nama_Chain.toUpperCase() + "_";
    let sortOrder = {};
    const stablecoins = ["USDT", "DAI", "USDC", "FDUSD"];

    // Fungsi umum untuk mendapatkan data dari localStorage
    function getFromLocalStorage(key, defaultValue) {
        return JSON.parse(localStorage.getItem(storagePrefix + key)) || defaultValue;
       // console.log("Data from localStorage:", data); // Debug log
    }

    // Fungsi umum untuk menyimpan data ke localStorage
    function saveToLocalStorage(key, value) {
        try {
            localStorage.setItem(storagePrefix + key, JSON.stringify(value));
           // console.log("Data saved successfully:", key);
        } catch (error) {
            // Tambahkan log untuk memverifikasi jenis error
            console.error("Error saat menyimpan data:", error);

            if (error.name === "QuotaExceededError") {
                // Tambahkan pengecekan ruang yang tersedia sebelum menyimpan
                let usedSpace = new Blob(Object.values(localStorage)).size;
                let totalSpace = 5 * 1024 * 1024; // Biasanya 5MB
                console.error(`Used space: ${usedSpace} bytes / Total allowed: ${totalSpace} bytes`);

                toastr.error("MEMORY BROWSER PENUH!!! Sisa ruang tidak mencukupi.");
            } else {
                toastr.error("Terjadi kesalahan tak terduga saat menyimpan data.");
            }
        }
    }


    // Fungsi untuk menghapus item dari localStorage
    function removeFromLocalStorage(key) {
        localStorage.removeItem(storagePrefix + key);
       // console.log("Remove from localStorage:", key); // Debug log
    }
    // Fungsi untuk mendapatkan data chain berdasarkan nama chain
    function getChainData(chainName) {
        const chainData = CONFIG_CHAINS[chainName]; // base
        
        if (!chainData) {
            console.log(`Chain dengan nama ${chainName} tidak ditemukan.`);
            return null;
        }
        return {
            Kode_Chain: chainData.Kode_Chain,
            Nama_Chain: chainData.Nama_Chain,
            DEXS: chainData.DEXS,
            PAIRDEXS: chainData.PAIRDEXS,
            URL_Chain: chainData.URL_Chain, 
            DATAJSON: chainData.DATAJSON, 
            BaseFEEDEX: chainData.BaseFEEDEX, 
            CEXCHAIN: chainData.WALLET_CEX,
            ICON_CHAIN: chainData.ICON,
            COLOR_CHAIN: chainData.WARNA,
        };
    }

    
   // Fungsi untuk memilih server secara acak dari array
   function getRandomServerFromCORSList() {
        const serverCORSList = getFromLocalStorage("SERVERCORS", []);  // Ambil data dari localStorage
    
        if (!serverCORSList || serverCORSList.length === 0) {
            toastr.warning("DATA SETTING TIDAK ADA, SILAKAN SYCN ULANG!!");
            return null; // Tidak ada server dalam daftar
        }
    
        // Pilih server secara acak
        const randomIndex = Math.floor(Math.random() * serverCORSList.length);
        return serverCORSList[randomIndex];
    }
    
    // Menggunakan fungsi untuk mendapatkan server CORS secara acak
    var selectedServer = getRandomServerFromCORSList();
    const DTChain = getChainData(chainName);  
    var SavedSettingData = getFromLocalStorage('DATA_SETTING', {});
    var DataTokens = getFromLocalStorage('TOKEN_SCANNER',[]);
    var MasterTokens = getFromLocalStorage('TOKEN',[]);
    var serverCORSList = getFromLocalStorage("SERVERCORS", []); 
    var WalletCEX = getFromLocalStorage("WALLET_CEX", []); 
    // Proses jika semua data valid
    var savedPairs = getFromLocalStorage("selectedPair", []);
    var savedCexs = getFromLocalStorage("selectedCEX", []);

    const dexList = [
            { id: 'D1INCH', Modal: SavedSettingData.Modal1INCH,  dex: '1inch' },
            { id: 'DODOS', Modal: SavedSettingData.ModalODOS, dex: 'odos' },
            { id: 'D0X', Modal: SavedSettingData.Modal0X,  dex: '0x' },
            { id: 'DKYBERSWAP', Modal: SavedSettingData.ModalKYBERSWAP, dex: 'kyberswap' },
            { id: 'DJUPITER', Modal: SavedSettingData.ModalJUPITER,  dex: 'jupiter' },
            { id: 'DOKX', Modal: SavedSettingData.ModalOKX,  dex: 'okx' },
            { id: 'DMAGPIE', Modal: SavedSettingData.ModalMAGPIE,  dex: 'magpie' },
            { id: 'DPARASWAP', Modal: SavedSettingData.ModalPARASWAP,  dex: 'paraswap' },
            { id: 'DOPENOCEAN', Modal: SavedSettingData.ModalPARASWAP,  dex: 'openocean' },
            { id: 'DKANA', Modal: SavedSettingData.ModalKANA,  dex: 'kana' }
        ];
    // filter dan sorting token pair
    //var filteredTokens = filterTokens();

    let filteredTokens = [];

    function filterTokens(strictMode) {
        const allTokens = getFromLocalStorage("TOKEN_SCANNER", []);
        const selectedCEX = getFromLocalStorage("CEX_PILIH", []);
        const selectedDEXPAIR = getFromLocalStorage("DEXPAIR_PILIH", []);
        const selectedDEX = getFromLocalStorage("DEX_PILIH", []);

        if (!Array.isArray(allTokens) || allTokens.length === 0) {
            console.warn("No tokens available for filtering.");
            filteredTokens = [];
            updateTokenCount();
            return;
        }

        console.warn("TOKEN PAIR", allTokens);
        console.warn("DEX is", selectedDEX.length);

        const isNonSelected = selectedDEXPAIR.includes("NON");
        const dexPairs = Object.keys(DTChain.PAIRDEXS).filter(pair => pair !== "NON");

        filteredTokens = allTokens.filter(token => {
            if (!token?.cex || !token?.symbol_in || !token?.symbol_out) return false;

            const validCEX = selectedCEX.includes(token.cex);
            const validDexPair = selectedDEXPAIR.some(pair => token.symbol_in === pair || token.symbol_out === pair) ||
                (isNonSelected && !dexPairs.some(pair => token.symbol_in === pair || token.symbol_out === pair));

            if (!validCEX || !validDexPair || !token.status) return false;
            if (strictMode && (!token.withdrawToken || !token.depositPair || !token.withdrawPair || !token.depositToken)) return false;
            
            return true;
        });

        if (filteredTokens.length === 0 && selectedCEX.length > 0 && selectedDEX.length > 0) {
            toastr.error("TIDAK ADA TOKEN-PAIR YANG SESUAI CEX/DEX/PAIRDEX !!");
            console.warn("No tokens matched the filtering criteria.");
        }

        updateTokenCount();
    }

    function updateTokenCount() {
        $("#tokenCount").text(`(${filteredTokens.length})`);
        console.warn("Tokens data", filteredTokens);
    }

    $("#strictFilter").on("change", function() {
        filterTokens($(this).is(":checked"));
    });

    // Inisialisasi dengan status awal checkbox
    filterTokens($("#strictFilter").is(":checked"));

    $("input[name='toggle']").change(function () {
        var selectedOption = $("input[name='toggle']:checked").val();
        if (selectedOption === "opt_B") {
            // Jika "Z" dipilih, balik urutan
            filteredTokens.reverse();
            toastr.info("SORTING TOKEN PAIR BERUBAH KE -Z");
        }else{
            toastr.info("SORTING TOKEN PAIR BERUBAH KE -A");
        }
        // Lakukan update tampilan sesuai perubahan sorting
        loadStoredData(filteredTokens);
    });
    //console.log("DATA TOKEN FILTER",filteredTokens);
    // Mapping konfigurasi untuk setiap exchange
    const exchangeConfig = {
        GATE: {
            url: coins => `https://api.gateio.ws/api/v4/spot/order_book?limit=5&currency_pair=${coins.symbol}_USDT`,
            processData: data => processOrderBook(data)
        },
        BINANCE: {
            url: coins => `https://api.binance.me/api/v3/depth?limit=4&symbol=${coins.symbol}USDT`,
            processData: data => processOrderBook(data)
        },
        MEXC: {
            url: coins => `https://api.mexc.com/api/v3/depth?symbol=${coins.symbol}USDT&limit=5`,
            processData: data => processOrderBook(data)
        },
        KUCOIN: {
          //  url: coins => `https://proxykiri.awokawok.workers.dev/?https://api.kucoin.com/api/v1/market/orderbook/level2_20?symbol=${coins.symbol}-USDT`,
            url: coins => `https://api.kucoin.com/api/v1/market/orderbook/level2_20?symbol=${coins.symbol}-USDT`,
            processData: data => {
                if (!data?.data?.asks || !data?.data?.bids) {
                    console.error('Invalid KUCOIN response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.data.bids.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.data.asks.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        },
        BITGET: {
            url: coins => `https://api.bitget.com/api/v2/spot/market/orderbook?symbol=${coins.symbol}USDT&limit=5`,
            processData: data => {
                if (!data?.data?.asks || !data?.data?.bids) {
                    console.error('Invalid BITGET response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.data.bids.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.data.asks.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        },
        BYBIT: {
            url: coins => `https://api.bybit.com/v5/market/orderbook?category=spot&limit=4&symbol=${coins.symbol}USDT`,
            processData: data => {
                if (!data?.result?.a || !data?.result?.b) {
                    console.error('Invalid BYBIT response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.result.b.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.result.a.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        },
        OKX: {
            url: coins => `https://www.okx.com/api/v5/market/books?instId=${coins.symbol}-USDT&sz=5`,
            processData: data => {
                if (!data?.data?.[0]?.asks || !data?.data?.[0]?.bids) {
                    console.error('Invalid OKX response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.data[0].bids.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.data[0].asks.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        }
    };   

     // Fungsi untuk mendapatkan fee gas dalam Gwei
     function feeGasGwei() {
        $.when(
            $.ajax({
                url: 'https://data-api.binance.vision/api/v3/ticker/24hr?symbol=' + DTChain.BaseFEEDEX,
                method: 'GET'
            }),
            $.ajax({
                url: 'https://gas.api.infura.io/v3/9d0429abadc34232af7d5c0e6ab98631/networks/' + DTChain.Kode_Chain + '/suggestedGasFees',
                method: 'GET'
            })
        ).done(function(PriceResponse, gasResponse) {
            var lastPrice = PriceResponse[0].lastPrice;
            saveToLocalStorage('PRICEGAS', lastPrice); // Menggunakan saveToLocalStorage
            var mediumGasFee = gasResponse[0].low.suggestedMaxFeePerGas;
            saveToLocalStorage('gasGWEI', mediumGasFee); // Menggunakan saveToLocalStorage
            
           // $("#LGwei").text("" + parseFloat(getFromLocalStorage('gasGWEI', 0)).toFixed(2)+" | "+DTChain.BaseFEEDEX+":"+parseFloat(getFromLocalStorage('PRICEGAS', 0)).toFixed(2)); // Menggunakan getFromLocalStorage

           //  console.log('Medium Gas Fee:', mediumGasFee);
        }).fail(function(error) {
            console.error('Failed to fetch data:', error);
        });
    }
    // Fungsi untuk menonaktifkan semua input di dalam form
    function form_off() {
        $('input, select, textarea, button').prop('disabled', true); 
    }

    // Fungsi untuk mengaktifkan semua input di dalam form
    function form_on() {
        $('input, select, button').prop('disabled', false);
    }

    UIkit.util.on('#modal-setting', 'show', function () {
        form_on();
    });

    function cekDataAwal() {

        var info = true; // Variabel status info
        let errorMessages = []; // Array untuk menyimpan pesan error

        // Validasi data dan push error ke array
        if (!MasterTokens.length) {
            errorMessages.push('TIDAK ADA DATA PADA SETTINGAN!!, SILAKAN KE MENU SETTINGAN.');
            $("#MasterData").addClass("icon-wrapper");
            $('#UpdateWalletCEX,#LoadDataBtn,#SettingModal').css('pointer-events', 'none').css('opacity', '0.4');
            info = false;
        } else if (!DataTokens.length) {
            form_off();
            $("#LoadDataBtn").addClass("icon-wrapper");
            errorMessages.push('<b>SILAKAN LOAD DATA TERLEBIH DAHULU !!</b><br/>');
            info = false;
        } else if (!SavedSettingData || SavedSettingData.walletMeta === '-') {
            errorMessages.push('CEK, SETTINGAN APLIKASI {MODAL,WALLET METAMASK}!');
            $("#SettingModal").addClass("icon-wrapper");
            form_off();
            info = false;
        } else if (!WalletCEX.length) {
            errorMessages.push('TIDAK ADA DATA WALLET CEX, SILAKAN UPDATE WALLET PADA MENU SETTINGAN!');
            $("#MasterData").addClass("icon-wrapper");
            $('#UpdateWalletCEX').css('pointer-events', 'none').css('opacity', '0.4');
            info = false;
        } else {
            loadStoredData(filteredTokens);
            generateInputCheckbox(savedCexs, "cex-options", "", "EXCH ", "uk-form-label uk-text-success");
            generateInputCheckbox(DTChain.DEXS, "dex-options", "D", "DEFI:", "uk-form-label uk-text-danger");
            generateInputCheckbox(savedPairs, "dexpair-options", "", "", "uk-form-label uk-text-primary");
            generateInputModal(DTChain.DEXS);            
            loadCheckboxSelections();

            let waktuTunggu=SavedSettingData.speedScan;
            let speed=0;
            if (waktuTunggu == "2") {
                speed = "NORMAL";
            } else if (waktuTunggu == "1.5") {
                speed = "MEDIUM";
            } else if (waktuTunggu == "1") {
                speed = "FAST";
            }else{
                speed = "ANOMALI";
            }
            $("#config").text(`FilterPNL: ${SavedSettingData.filterPNL} | Grup: ${SavedSettingData.scanPerKoin} ~ ${speed} [${SavedSettingData.jedaTimeGroup}-${SavedSettingData.jedaKoin}] | Gwei: ${parseFloat(getFromLocalStorage('gasGWEI', 0)).toFixed(2)}`)
            // hitung total token
            const jml = DataTokens.filter(item => 
                item.status === true 
                /* 
                && 
                item.withdrawToken === true && item.depositPair === true && 
                item.withdrawPair === true && item.depositToken === true
                */
            ).length;

            $('#tokenCountALL').text(`TOTAL SEMUA: ${jml} PAIR-TOKEN`);  
        }

        // Update link dengan parameter baru
        var link = $('a[href="multipair.html"]'); // Pilih elemen link
        var href = link.attr('href'); // Ambil URL href
        link.attr('href', href + "?chain=" + encodeURIComponent(chainName)); // Update href dengan parameter baru

        // Tampilkan semua pesan error ke #infoAPP
        if (!info) {
            $("#infoAPP").show().html(errorMessages.join("<br/>")); // Gabungkan semua pesan error
        }

        // Proses aksi terakhir jika kondisi terpenuhi
        var dataACTION = getFromLocalStorage('HISTORY');
        if (info && dataACTION && dataACTION.time) {
            $("#infoAPP").show().text(`${dataACTION.action} at ${dataACTION.time}`);
        }
    }


    $(document).ready(function() {  
      
        if (typeof CONFIG_CEX !== 'undefined' && typeof CONFIG_CHAINS !== 'undefined') {
            const currentPage = window.location.pathname.split('/').pop(); // Mengambil bagian terakhir dari path URL
            const selectedChain = CONFIG_CHAINS[Nama_Chain.toLowerCase()];
                // Pastikan data chain ditemukan
                if (selectedChain) {                    
                    // console.log(`Data untuk chain ${chainName}:`, DTChain);                
                    // console.log(`CEXS `, CONFIG_CEX); 
                    // console.log(`DEXS `, DTChain.DEXS); 
                    // generate CEX,DEX dan PAIR
                    
                    // Update tampilan dengan nama chain dan warna
                    $('title').text("SCANNER " + Nama_Chain.toUpperCase());
                    $('#namachain').text(Nama_Chain.toUpperCase());
                    $('#namachain2').text("CHAIN " + Nama_Chain.toUpperCase());
                     $('h2#judul').css('color', selectedChain.WARNA);
                    $('#favicon').attr('href', DTChain.ICON_CHAIN); 
                    $('#sinyal-container').css('color', 'black');
                    $('#progress-bar').css('background-color', selectedChain.WARNA);
                    $('h4#daftar').css({'text-align': 'center','color': selectedChain.WARNA,'padding-left':'4px'});
                   
                    cekDataAwal();
                        
                    // Untuk setiap chain yang ada di CONFIG_CHAINS dibuatkan ICON LINK CHAIN
                    Object.keys(CONFIG_CHAINS).forEach(chainKey => {
                        const chain = CONFIG_CHAINS[chainKey];
                        const isActive = chain.Nama_Chain === Nama_Chain;
                        const linkHTML = `<span class="chain-link" style="${!isActive ? 'opacity: 0.3;' : ''}">
                                <a href="${currentPage}?chain=${chain.Nama_Chain}" ><img src="${chain.ICON}" alt="${chain.Nama_Chain} icon" width="${isActive ? '30' : '30'}"></a></span>`;
                        $('#chain-links-container').append(linkHTML);
                    });
                } else {
                    alert(`Chain dengan nama ${Nama_Chain} tidak ditemukan.`);
                }
            } else {
                console.warn("CONFIG tidak tersedia.");
            }

            $('#searchInput').on('input', function() {
                const searchValue = $(this).val().toLowerCase();
                $('#dataTableBody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(searchValue) > -1);
                });
            });

            $('#LoadDataBtn').on('click', function() {
                // Ambil data dari localStorage dengan key "TOKEN_SCANNER"
                const storedData = getFromLocalStorage("TOKEN", []); // Ambil data token yang sudah ada
                const WalletCEXData = getFromLocalStorage("WALLET_CEX", []); // Ambil data Wallet CEX dari localStorage

                // Gabungkan data dari TOKEN dan status dari WALLET_CEX
                const combinedData = storedData.map(token => {
                        // Cari data wallet CEX berdasarkan CEX dan tokenName yang sesuai untuk withdraw (symbol_in)
                        const walletToken = WalletCEXData.find(item =>
                            item.cex === token.cex && item.tokenName === token.symbol_in
                        );

                        // Cari data wallet CEX berdasarkan CEX dan tokenName yang sesuai untuk deposit (symbol_out)
                        const walletPair = WalletCEXData.find(item =>
                            item.cex === token.cex && item.tokenName === token.symbol_out
                        );

                        // Gabungkan data token dengan status wallet
                        return {
                            ...token,  // Gabungkan data token yang sudah ada
                            feeWDToken: walletToken ? walletToken.feeWDs : "",
                            feeWDPair: walletPair ? walletPair.feeWDs : "", 
                            depositPair: walletPair ? walletPair.depositEnable : false,  // Status Deposit
                            withdrawToken: walletToken ? walletToken.withdrawEnable : false,  // Status Withdraw
                            depositToken: walletToken ? walletToken.depositEnable : false,  // Status Deposit
                            withdrawPair: walletPair ? walletPair.withdrawEnable : false  // Status Withdraw

                        };
                });

                // Konfirmasi dari pengguna
                if (confirm('LOAD DATA AKAN MERUBAH DATA SEBELUMNYA, LANJUTKAN??')) {
                    saveToLocalStorage("TOKEN_SCANNER", combinedData);

                    const savedData = getFromLocalStorage("TOKEN_SCANNER", []);
                    // Validasi apakah data berhasil disimpan
                    if (savedData.length === combinedData.length) {
                        toastr.info("LOADING DATA TOKEN PAIR...", {
                            timeOut: 3000, // Durasi toast (4 detik)
                            progressBar: true,
                            closeButton: true,
                        });

                        // Refresh halaman untuk memperbarui data
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        toastr.error("LOAD DATA GAGAL!", {
                            timeOut: 4000,
                            progressBar: true,
                            closeButton: true,
                        });
                    }
                } else {
                    // Jika pengguna menekan "Tidak", tidak ada aksi yang dilakukan
                    toastr.info("PROSES LOAD DATA DIBATALKAN OLEH PENGGUNA.", {
                        timeOut: 3000,
                        progressBar: true,
                        closeButton: true,
                    });
                }
            });

            $("#stopSCAN,#reload").click(function () {
                location.reload();
            });
            
    });

    function formatPrice(price) {
        if (price >= 1) {
            return price.toFixed(3) + '$'; // Jika >= 1, tampilkan 2 angka desimal
        }

        let strPrice = price.toFixed(20).replace(/0+$/, ''); // Paksa format desimal, hapus nol di akhir
        let match = strPrice.match(/0\.(0*)(\d+)/); // Ambil nol setelah koma dan angka signifikan

        if (match) {
            let zeroCount = match[1].length; // Hitung jumlah nol setelah koma
            let significant = match[2].substring(0, 4); // Ambil 5 digit signifikan pertama

            // Jika angka signifikan kurang dari 5 digit, tambahkan nol di akhir
            significant = significant.padEnd(4, '0');

            if (zeroCount >= 2) {
                return `0.{${zeroCount}}${significant}$`; // Format dengan {N} jika nol >= 2
            } else {
                return `0.${match[1]}${significant}$`; // Format biasa jika nol < 2
            }
        }

        return price.toFixed(6) + '$'; // Fallback jika format tidak dikenali
    }

    //scan dengan batas maksimum eksekusi pergrup (speedscan)
    $("#startSCAN").click(function () {
        cekDataAwal();
        //  sendStatusTELE(SavedSettingData.nickname, 'ONLINE');
        CekIdentitas();
        $('#sinyal-container span[id^="sinyal"]').empty();
        form_off();

        $("#stopSCAN").show().prop('disabled', false);

        $('#LoadDataBtn, #SettingModal, #MasterData,#UpdateWalletCEX, #chain-links-container').css('pointer-events', 'none').css('opacity', '0.4');

        // Pastikan checkbox tetap aktif dan bisa diubah statusnya
        $('.statusCheckbox').css({ 'pointer-events': 'auto', 'opacity': '1' }).prop('disabled', false);

        let ConfigScan = getFromLocalStorage('DATA_SETTING', {});
        let scanPerKoin = parseInt(ConfigScan.scanPerKoin);
        let jedaKoin = parseInt(ConfigScan.jedaKoin);
        let jedaTimeGroup = parseInt(ConfigScan.jedaTimeGroup);
        let dexList = getFromLocalStorage("DEX_PILIH", []);

        let speedScan = parseInt(getFromLocalStorage('SavedSettingData.speedScan', 500)) * 1000; // Ambil speedScan dari localStorage, default 1000ms

        // Semaphore untuk membatasi jumlah request yang berjalan secara bersamaan
        let maxConcurrentRequests = scanPerKoin; // Sesuaikan dengan batasan yang diinginkan
        let currentRequests = 0;
        let requestQueue = [];

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateProgress(current, total, startTime, TokenPair) {
            let duration = ((Date.now() - startTime) / 1000 / 60).toFixed(2);
            let progressPercentage = Math.floor((current / total) * 100);
            let progressText = `CHECKING - ${TokenPair} [${current}/${total}] :: Mulai: ${new Date(startTime).toLocaleTimeString()} ~ DURASI [${duration} Menit]`;

            $('#progress-bar').css('width', progressPercentage + '%');
            $('#progress-text').text(progressPercentage + '%');
            $('#progress').text(progressText);
        }

        async function processRequest(token) {
            currentRequests++;
            try {
                let cex = token.cex.toUpperCase();
                let symbolIn = token.symbol_in.toUpperCase();
                let symbolOut = token.symbol_out.toUpperCase();
                let sc_input = token.sc_in.toString();
                let sc_output = token.sc_out.toString();
                let des_input = token.des_in;
                let des_output = token.des_out;
                let NameToken = token.symbol_in.toUpperCase();
                let NamePair = token.symbol_out.toUpperCase();

                let TokenPair = `${symbolIn}_${symbolOut}`;
                let PairToken = `${symbolOut}_${symbolIn}`;

                await new Promise((resolve, reject) => {
                    let timeout = setTimeout(() => reject("Timeout"), speedScan);
                    //console.log("Detail TOKEN PAIR",token);
                    getPriceCEX(token, token.symbol_in, token.symbol_out, token.cex, (error, DataCEX) => {
                        clearTimeout(timeout);
                        if (error) {
                            console.error("Error data from CEX:", error);
                            toastr.error(`Cek Ulang Harga ${symbolIn} atau ${symbolOut} Exchanger : ${cex}`);
                            resolve();
                            $('#' + cex + '_' + TokenPair + '_' + (DTChain.Nama_Chain).toUpperCase()).css('background-color', '#949191');
                            return;
                        } else {
                            let priceBuyTokenCEX = DataCEX.volumes_buyToken[2]?.price || "N/A";
                            let priceSellTokenCEX = DataCEX.volumes_sellToken[0]?.price || "N/A";

                            let priceBuyPairCEX = DataCEX.volumes_buyPair[2]?.price || "N/A";
                            let priceSellPairCEX = DataCEX.volumes_sellPair[0]?.price || "N/A";

                            dexList.forEach((dex) => {
                                let IdTokentoPair = `${cex}_${dex.toUpperCase()}_${TokenPair}_${(DTChain.Nama_Chain).toUpperCase()}`;
                                let IdPairtoToken = `${cex}_${dex.toUpperCase()}_${PairToken}_${(DTChain.Nama_Chain).toUpperCase()}`;
                                
                                let modalKey = `MODAL_${dex.toUpperCase()}`;
                                let modalValue = SavedSettingData[modalKey];
                                let dextype = dex.toLowerCase();
                                var Modal = parseFloat(modalValue);
                                var amount_in_pair = parseFloat(Modal) / parseFloat(priceBuyPairCEX);
                                var amount_in_token = parseFloat(Modal) / parseFloat(priceBuyTokenCEX);
                                 // token to pair
                                
                                if ($(`#${IdTokentoPair}`).length) {
                                    getPriceDEX(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, dextype, NameToken, NamePair, cex,'TokentoPair', function (error, DataDEX) {
                                        if (error || !DataDEX) {
                                            $(`#${IdTokentoPair}`).css('background-color', error.color);
                                            $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${error.pesanDEX}">[ERROR]</span>`);
                                              
                                                if ((error.statusCode == 0 && (dextype == "kyberswap"  ||  dextype == "0x")) || 
                                                    (error.statusCode == 429 && dextype == "okx") || 
                                                    (error.statusCode == 403 && dextype == "0x")){

                                                   // toastr.info(`${TokenPair} ${dextype} PINDAH SERVER`);
                                                    var amount_in = BigInt(Math.round(Math.pow(10, des_input) * amount_in_token));
                                                    getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, priceBuyPairCEX, dextype, NameToken, NamePair, cex,'TokentoPair', function (altError, altDataDEX){  
                                                        if (!altError) {
                                                            $(`#${IdTokentoPair}`).css('background-color', '#f9f9e4');
                                                            $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                            $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                                ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_input, sc_output, cex, Modal, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair');
                                                            }
                                                        else{
                                                                $(`#${IdTokentoPair}`).css('background-color',altError.color);
                                                                $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${altError.pesanDEX}">[ERROR]</span>`);
                                                        }
                                                    });
                                                }
                                                // if (dextype === "kana") {
                                                //    // toastr.info(`${TokenPair} ${dextype} PINDAH SERVER`);
                                                //     getPriceDEX(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, 'paraswap', NameToken, NamePair, cex,'TokentoPair', function (altError, altDataDEX){  
                                                //         if (!altError) {
                                                //             $(`#${IdTokentoPair}`).css('background-color', '#f9f9e4');
                                                //             $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                //             $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                //                 ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_input, sc_output, cex, Modal, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair');
                                                //             }
                                                //         else{
                                                //                 $(`#${IdTokentoPair}`).css('background-color',altError.color);
                                                //                 $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a> <span title="TIDAK DAPAT HARGA">[ERROR]</span>`);
                                                //         }
                                                //     });
                                                // }
                                                if (dextype === "odos") {
                                                   // toastr.info(`${TokenPair} ${dextype} PINDAH SERVER`);
                                                    getPriceDEX(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, 'altodos', NameToken, NamePair, cex,'TokentoPair', function (altError, altDataDEX){  
                                                        if (!altError) {
                                                            $(`#${IdTokentoPair}`).css('background-color', '#f9f9e4');
                                                            $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                            $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                                ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_input, sc_output, cex, Modal, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair');
                                                            }
                                                        else{
                                                                $(`#${IdTokentoPair}`).css('background-color',altError.color);
                                                                $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a> <span title="TIDAK DAPAT HARGA">[ERROR]</span>`);
                                                        }
                                                    });
                                                }
                                            return;
                                        } else {
                                           // $(`#${IdTokentoPair}`).css('background-color', "#f9f9e4");
                                            $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                            $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                            
                                            ResultEksekusi(DataDEX.amount_out,DataDEX.FeeSwap,sc_input, sc_output, cex, Modal, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair');
                                        }
                                    });
                                }                               
                                
                                // pair to token
                                
                                if ($(`#${IdPairtoToken}`).length) {
                                   getPriceDEX( sc_output, des_output,sc_input, des_input, amount_in_pair, priceBuyPairCEX, dextype, NamePair, NameToken, cex,'PairtoToken', function (error, DataDEX) {
                                        if (error || !DataDEX) {
                                            $(`#${IdPairtoToken}`).css('background-color', error.color);
                                            $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${error.pesanDEX}">[ERROR]</span>`);
                                                
                                                    if ((error.statusCode == 0 && (dextype == "kyberswap" ||  dextype == "0x")) || 
                                                    
                                                    (error.statusCode == 429 && dextype == "okx") ||
                                                     (error.statusCode == 403 && dextype == "0x")) {

                                                   // toastr.info(`${PairToken} ${dextype} PINDAH SERVER`);
                                                    var amount_in = BigInt(Math.round(Math.pow(10, des_output) * amount_in_pair));
                                                    getPriceSWOOP( sc_output, des_output,sc_input, des_input, amount_in, priceBuyPairCEX, dextype, NamePair, NameToken, cex,'PairtoToken', function (altError, altDataDEX){                                                                
                                                        if (!altError) {
                                                            $(`#${IdPairtoToken}`).css('background-color', '#f9f9e4');
                                                            $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                            $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);

                                                            ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_output, sc_input, cex, Modal, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken');
                                                        }else{
                                                            $(`#${IdPairtoToken}`).css('background-color',altError.color);
                                                            $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${altError.pesanDEX}">[ERROR]</span>`);
                                                        }
                                                    });
                                                }  
                                            //     if(dextype==="kana"){
                                            //         //toastr.info(`${PairToken} ${dextype} PINDAH SERVER`);
                                            //         getPriceDEX( sc_output, des_output,sc_input, des_input, amount_in_pair, priceBuyPairCEX, 'paraswap', NamePair, NameToken, cex,'PairtoToken', function (altError, altDataDEX){                                                                
                                            //             if (!altError) {
                                            //                 $(`#${IdPairtoToken}`).css('background-color', '#f9f9e4');
                                            //                 $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                            //                 $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);

                                            //                 ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_output, sc_input, cex, Modal, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken');
                                            //             }else{
                                            //                 $(`#${IdPairtoToken}`).css('background-color',altError.color);
                                            //                 $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a>  <span title="TIDAK DAPAT HARGA">[ERROR]</span>`)
                                            //             }
                                            //     });
                                            // }
                                            if(dextype==="odos"){
                                                   // toastr.info(`${PairToken} ${dextype} PINDAH SERVER`);
                                                    getPriceDEX( sc_output, des_output,sc_input, des_input, amount_in_pair, priceBuyPairCEX, 'altodos', NamePair, NameToken, cex,'PairtoToken', function (altError, altDataDEX){                                                                
                                                        if (!altError) {
                                                            $(`#${IdPairtoToken}`).css('background-color', '#f9f9e4');
                                                            $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                            $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);

                                                            ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_output, sc_input, cex, Modal, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken');
                                                        }else{
                                                            $(`#${IdPairtoToken}`).css('background-color',altError.color);
                                                            $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a>  <span title="TIDAK DAPAT HARGA">[ERROR]</span>`)
                                                        }
                                                });
                                            }
                                            return;
                                        } else {
                                           // $(`#${IdPairtoToken}`).css('background-color', "#f9f9e4");
                                            $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                            $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);
                                           
                                            ResultEksekusi(DataDEX.amount_out,DataDEX.FeeSwap,sc_output, sc_input, cex, Modal, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken');
                                        }
                                    });
                                }
                                
                            });

                            resolve();
                        }
                    });
                });

                await delay(jedaKoin);
            } catch (error) {
                console.error(`Kesalahan saat memproses ${token.symbol_in}_${token.symbol_out}:`, error);
            } finally {
                currentRequests--;
                if (requestQueue.length > 0) {
                    let nextRequest = requestQueue.shift();
                    nextRequest();
                }
            }
        }

        async function processTokens() {
            let startTime = Date.now();
            let totalTokens = filteredTokens.length;
            let currentProcessed = 0;

            let tokenGroups = [];
            for (let i = 0; i < filteredTokens.length; i += scanPerKoin) {
                tokenGroups.push(filteredTokens.slice(i, i + scanPerKoin));
            }

            for (let groupIndex = 0; groupIndex < tokenGroups.length; groupIndex++) {
                let groupTokens = tokenGroups[groupIndex];
                console.log(`Memproses grup ${groupIndex + 1} dari ${tokenGroups.length}`);
                feeGasGwei();

                for (let tokenIndex = 0; tokenIndex < groupTokens.length; tokenIndex++) {
                    let token = groupTokens[tokenIndex];

                    updateProgress(
                        currentProcessed + tokenIndex + 1,
                        totalTokens,
                        startTime,
                        `${token.symbol_in}_${token.symbol_out}`
                    );

                    if (currentRequests >= maxConcurrentRequests) {
                        await new Promise(resolve => requestQueue.push(resolve));
                    }

                    await processRequest(token);
                }

                currentProcessed += groupTokens.length;
                console.log(`Grup ${groupIndex + 1} selesai diproses`);
                await delay(jedaTimeGroup);
            }


            updateProgress(totalTokens, totalTokens, startTime, "SELESAI");
            form_on();

            $("#stopSCAN").hide().prop("disabled", false);
            $("#LoadDataBtn, #SettingModal, #MasterData,#UpdateWalletCEX,#chain-links-container").css("pointer-events", "auto").css("opacity", "1");
        }

        processTokens();
    });
  
    //genereta inputan checkbox
    function generateInputCheckbox(items, containerId, idPrefix, labelText, style) {
        const $container = $(`#${containerId}`);
        $container.empty(); // Bersihkan container

        // Variabel untuk jumlah token (khusus untuk cex-options)
        let jml = 0;
        // Hitung jumlah token hanya jika containerId adalah "cex-options"
        if (containerId === "cex-options") {
            jml = filteredTokens.filter(t => t.status === true && items.includes(t.cex)).length;
        }
   
        // Tambahkan label di atas checkbox
        const label = `
            <b>
                <span class="uk-text-secondary uk-text-medium">
                    ${labelText}
                </span>
            </b>
        `;
        $container.append(label);

        // Jika `items` adalah objek, ubah menjadi array key
        if (typeof items === 'object' && !Array.isArray(items)) {
            items = Object.keys(items); // Ambil key dari objek
        }

        // Iterasi dan tambahkan checkbox beserta label
        const checkboxWrapper = $('<div style="display: flex; flex-wrap: wrap; gap: 10px;"></div>'); // Bungkus checkbox
        items.forEach(item => {
            const checkboxId = `${idPrefix}${item.toUpperCase()}`;

            const countForCEX = containerId === "cex-options" 
                ? DataTokens.filter(t => t.status === true && t.cex === item).length 
                /*  && t.depositPair === true && t.withdrawToken === true && t.depositToken === true && t.withdrawPair === true).length */
                : ""; // Hanya hitung jumlah token untuk cex-options
            const checkbox = `
                <label class="${style || ''}" for="${checkboxId}">
                    <input type="checkbox" id="${checkboxId}" value="${item}" checked>
                    ${item.toUpperCase()}${containerId === "cex-options" ? ` (${countForCEX})` : ""}
                </label>`;
            checkboxWrapper.append(checkbox);
        });

        $container.append(checkboxWrapper); // Masukkan checkbox ke dalam container
    }

    // Fungsi untuk memuat data dari localStorage saat halaman dimuat
    function loadCheckboxSelections() {
        let errorMessages = [];
        // Muat data CEX
        const savedCEX = getFromLocalStorage("CEX_PILIH", []);
        $('#cex-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedCEX.includes($(this).val()));
        });
        // Muat data DEX
        const savedDEX = getFromLocalStorage("DEX_PILIH", []);
        $('#dex-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedDEX.includes($(this).val()));
        });

        // Muat data DEXPAIR
        const savedDEXPAIR = getFromLocalStorage("DEXPAIR_PILIH", []);
        $('#dexpair-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedDEXPAIR.includes($(this).val()));
        });

      //  const pilihCex = getFromLocalStorage('CEX_PILIH', null);
        if (!savedCEX || !Array.isArray(savedCEX) || savedCEX.length === 0) {
            errorMessages.push('SILAKAN PILIH CEX!');
            $("#cex-options").addClass("error");
            form_on(); // tetap off jika `PILIH_CEX` belum diatur
        }
        
        //const pilihDex = getFromLocalStorage('DEX_PILIH', null);
        if (!savedDEX || !Array.isArray(savedDEX) || savedDEX.length === 0) {
            errorMessages.push('SILAKAN PILIH DEX!');
            $("#dex-options").addClass("error");
            form_on(); // tetap off jika `PILIH_DEX_PAIR` belum diatur
        }  
       // const pilihDexPair = getFromLocalStorage('DEXPAIR_PILIH', null);
        if (!savedDEXPAIR || !Array.isArray(savedDEXPAIR) || savedDEXPAIR.length === 0) {
            errorMessages.push('SILAKAN PILIH DEX PAIR!');
            $("#dexpair-options").addClass("error");
            form_on(); // tetap off jika `PILIH_DEX_PAIR` belum diatur
        }   
        $("#InfoAPP").html(errorMessages.join('<br/>')).addClass("text-large");    
    }
   
    $("#strictFilter").on("change", function() {
        var useStrictFilter = $(this).is(":checked");
        console.log("CLOSE WALLET DEX:", useStrictFilter);
    });

    // Fungsi untuk menentukan warna berdasarkan nama CEX
    function getWarnaCEX(cex) {
        const cexConfig = CONFIG_CEX[cex.toUpperCase()]; // Ambil konfigurasi berdasarkan nama CEX
        return cexConfig && cexConfig.WARNA ? cexConfig.WARNA : 'black'; // Gunakan warna dari konfigurasi atau 'black' jika tidak ditemukan
    }

    //fungsi filter TOKEN berdasarkan CEX,DEX dan DEX-PAIR
    
    // Fungsi untuk menampilkan sinyal DEX
    function loadSignalData() {
        let selectedDEX = getFromLocalStorage('DEX_PILIH', []); // Ambil pilihan DEX dari localStorage
        const appSettings = getFromLocalStorage('DATA_SETTING', {});

        let sinyalContainer = document.getElementById('sinyal-container');
        sinyalContainer.innerHTML = ''; // Kosongkan sebelumnya jika ada perubahan

        selectedDEX.forEach(dex => {
            const modalName = appSettings[`MODAL_${dex.toUpperCase()}`] || 0;
            // Menambahkan elemen sinyal untuk setiap DEX yang dipilih
            let sinyalItem = document.createElement('div');
            sinyalItem.classList.add('sinyal-item');
            sinyalItem.setAttribute('data-dex', `${dex}`);

            let label = document.createElement('b');
            label.innerText = dex.toUpperCase(); // Menampilkan nama DEX

            let signalSpan = document.createElement('span');
            signalSpan.classList.add('uk-text', 'uk-text-small', 'uk-text-primary');
            signalSpan.setAttribute('id', `sinyal${dex.toLowerCase()}`); // ID dinamis untuk sinyal setiap DEX

            sinyalItem.appendChild(label);
            sinyalItem.innerHTML += ` <b>[${modalName}] :</b> `; // Separator
            sinyalItem.appendChild(signalSpan);

            sinyalContainer.appendChild(sinyalItem);
        });
    }
    
    function createLink(url, text, className = '') {
        return url
            ? `<a href="${url}" target="_blank" class="${className}"><b>${text}</b></a>`
            : `<b>${text}</b>`;
    }
    // Menampilkan Semua DETAIL TOKEN PAIR dalam tabel
    function loadStoredData(filteredData) {
        $('.table-header th').css('background-color', DTChain.COLOR_CHAIN);
        loadSignalData();
       // console.warn("KOIN FILTERING",filteredData);
        const selectedDEX = getFromLocalStorage('DEX_PILIH', []);
        const appSettings = getFromLocalStorage('DATA_SETTING', {});
        const $InfoStatus = $('#InfoStatus');
        const $tableBody = $('#dataTableBody');
        const $headerRow = $('.table-header');

        $InfoStatus.text("Sedang Memuat DATA TOKEN...").show();

        if (!Array.isArray(filteredData) || filteredData.length === 0) {
            $InfoStatus.text("Tidak ada data token yang ditemukan.");
            setTimeout(() => $InfoStatus.fadeOut(), 2000);
            return;
        }

        // Kosongkan tabel dengan lebih efisien
        while ($tableBody.firstChild) {
            $tableBody.removeChild($tableBody.firstChild);
        }

        $tableBody.empty(); 
        // Optimasi Header dengan Fragment
        if ($headerRow.children().length !== selectedDEX.length + 4) {
            const headerFragment = document.createDocumentFragment();
            $headerRow.empty();

            let th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'PRICE & VOL BUY';
            headerFragment.appendChild(th);

            selectedDEX.forEach(dex => {
                let th = document.createElement('th');
                th.className = 'header';
                th.textContent = `${dex} [${appSettings[`MODAL_${dex.toUpperCase()}`] || 0}]`;
                headerFragment.appendChild(th);
            });

            th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'DETAIL TOKEN';
            headerFragment.appendChild(th);

            selectedDEX.forEach(dex => {
                let th = document.createElement('th');
                th.className = 'header';
                th.textContent = `${dex} [${appSettings[`MODAL_${dex.toUpperCase()}`] || 0}]`;
                headerFragment.appendChild(th);
            });

            th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'PRICE & VOL SELL';
            headerFragment.appendChild(th);

            $headerRow.append(headerFragment);
        }

        const fragment = document.createDocumentFragment();

        filteredData.forEach((data, index) => {
            const warnaCEX = getWarnaCEX(data.cex);
            const urlsCEX = GeturlExchanger(data.cex, data.symbol_in, data.symbol_out);
            const urlsCEXToken = GeturlExchanger(data.cex, data.symbol_in, data.symbol_in);
            const urlsCEXPair = GeturlExchanger(data.cex, data.symbol_out, data.symbol_out);

            // Status withdraw dan deposit dengan link
            const withdrawToken = data.withdrawToken ? createLink(urlsCEXToken.withdrawUrl, 'WD') : `<b style="color:red; font-weight:bold;">WX</b>`;
            const depositToken = data.depositToken ? createLink(urlsCEXToken.depositUrl, 'DP') : `<b style="color:red; font-weight:bold;">DX</b>`;

            const withdrawPair = data.withdrawPair ? createLink(urlsCEXPair.withdrawUrl, 'WD') : `<b style="color:red; font-weight:bold;">WX</b>`;
            const depositPair = data.depositPair ? createLink(urlsCEXPair.depositUrl, 'DP') : `<b style="color:red; font-weight:bold;">DX</b>`;

            // Link untuk SC dan stok token pair
            const linkToken = createLink(urlsCEX.tradeToken, data.symbol_in.toUpperCase());
            const linkPair = createLink(urlsCEX.tradePair, data.symbol_out.toUpperCase());
            
            const linkStokToken = Object.keys(DTChain.CEXCHAIN[data.cex])
                .filter((key) => key.includes('address'))
                .map((key, idx) => createLink(`${DTChain.URL_Chain}/token/${data.sc_in}?a=${DTChain.CEXCHAIN[data.cex][key]}`, `#${idx + 1} `))
                .join('');

            const linkStokPair = Object.keys(DTChain.CEXCHAIN[data.cex])
                .filter((key) => key.includes('address'))
                .map((key, idx) => createLink(`${DTChain.URL_Chain}/token/${data.sc_out}?a=${DTChain.CEXCHAIN[data.cex][key]}`, `#${idx + 1} `))
                .join('');

            // Link DEX
            const linkOKDEX = createLink(`https://www.okx.com/web3/dex-swap?inputChain=${DTChain.Kode_Chain}&inputCurrency=${data.sc_in}&outputChain=501&outputCurrency=${data.sc_out}`, '#OKXD', 'uk-text-secondary');
            const linkUNIDEX = createLink(`https://app.unidex.exchange/?chain=${DTChain.Nama_Chain}&from=${data.sc_in}&to=${data.sc_out}`, '#UNDX', 'uk-text-danger');
            const linkRango = createLink(`https://app.rango.exchange/bridge?fromBlockchain=${DTChain.Kode_Chain}&toBlockchain=${DTChain.Kode_Chain}&fromToken=${data.symbol_in}--${data.sc_in}&toToken=${data.symbol_out}--${data.sc_out}`, '#RNGX', 'uk-text-success');
            const linkRBX = createLink(`https://app.rubic.exchange/?fromChain=${DTChain.Nama_Chain.toUpperCase()}&toChain=${DTChain.Nama_Chain.toUpperCase()}&from=${data.sc_in}&to=${data.sc_out}`, '#RBCX', 'uk-text-warning');
            const linkDEFIL = createLink(`https://swap.defillama.com/?chain=${DTChain.Nama_Chain}&from=${data.sc_in}&to=${data.sc_out}`, '#DFLX', 'uk-text-primary');
            const OPEN = createLink(` https://app.openocean.finance/swap/${DTChain.Nama_Chain}/${data.symbol_in}/${data.symbol_out}`, '#OPEN', 'uk-text-danger');

            let row = document.createElement('tr');
            row.dataset.index = index;
            row.id = `${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}`;

            row.innerHTML = `
                <td style="text-align:center; vertical-align: middle;" class="uk-text-success">
                    <span id="LEFT_${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}">PRICE & VOL BUY <br>${data.cex}</span>
                </td>
            `;

            selectedDEX.forEach(dex => {
                const idCELL = `${data.cex}_${dex.toUpperCase()}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}`;
                let td = document.createElement('td');
                td.className = 'uk-text-center';
                td.style.verticalAlign = 'middle';
                td.id = idCELL;
                td.innerHTML = `
                    <a href="#"><span class="buy" id="LEFT_${idCELL}" title="LEFT_${idCELL}">  </span></a><br>
                    <span class="uk-text-primary uk-text-bolder" id="SWAP_${idCELL}">  </span><br>
                    <a href="#"><span class="sell" id="RIGHT_${idCELL}" title="RIGHT_${idCELL}">  </span></a><br>
                    <hr class="uk-divider-small uk-margin-remove">
                    <span class="uk-text-primary" id="RESULT_${idCELL}">  </span>
                `;
                row.appendChild(td);
            });

            let detailTd = document.createElement('td');
            detailTd.className = 'uk-text-center uk-background uk-text-nowrap';

            detailTd.innerHTML = `
                <input type="checkbox" class="statusCheckbox" data-id="${index}" data-index="${data.no}" ${data.status ? 'checked' : ''}>#${index+1}
                 <span style="color: ${warnaCEX}; font-weight:bolder;">${data.cex} </span><br/>
                <span class="uk-text-secondary uk-text-bolder">${linkToken} VS ${linkPair}</span><br>
               <span class="uk-text-primary uk-text-bolder">${withdrawToken}~${depositToken}</span> | <span class="uk-text-primary uk-text-bolder">${withdrawPair}~${depositPair}</span> <br/>
               
                <span class="uk-text-primary uk-text-bolder">${data.symbol_in}</span> 
                <a href="${DTChain.URL_Chain}/token/${data.sc_in}" target="_blank" class="uk-link">[SC]</a>: ${linkStokToken}<br>    
                <span class="uk-text-primary uk-text-bolder">${data.symbol_out}</span> 
                <a href="${DTChain.URL_Chain}/token/${data.sc_out}" target="_blank" class="uk-link">[SC]</a>: ${linkStokPair}<br>                   
               ${linkUNIDEX} ${linkDEFIL} ${linkOKDEX}
            `;

            row.appendChild(detailTd);

            selectedDEX.forEach(dex => {
                const idCELL = `${data.cex}_${dex.toUpperCase()}_${data.symbol_out}_${data.symbol_in}_${DTChain.Nama_Chain.toUpperCase()}`;
                let td = document.createElement('td');
                td.className = 'uk-text-center';
                td.style.verticalAlign = 'middle';
                td.id = idCELL;
                td.innerHTML = `
                    <a href="#"><span class="buy" id="LEFT_${idCELL}" title="LEFT_${idCELL}">  </span></a><br>
                    <span class="uk-text-primary uk-text-bolder" id="SWAP_${idCELL}">  </span><br>
                    <a href="#"><span class="sell" id="RIGHT_${idCELL}" title="RIGHT_${idCELL}">  </span></a><br>
                    <hr class="uk-divider-small uk-margin-remove">
                    <span class="uk-text-primary" id="RESULT_${idCELL}">  </span>
                `;
                row.appendChild(td);
            });

            row.innerHTML += `
                <td style="text-align:center; vertical-align: middle;" class="uk-text-danger">
                    <span id="RIGHT_${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}">PRICE & VOL SELL <br>${data.cex}</span>
                </td>
            `;

            fragment.appendChild(row);
        });

        $tableBody.append(fragment);

        $('#tokenCount').text(`(${filteredData.length})`);

        $InfoStatus.text("SELESAI, Memuat DATA TOKEN !!");
        if (selectedDEX.length <= 6) {
            $("#startSCAN").show();
        }else{
            alert("❌ MAX 6 DEX, SILAKAN KURANGI!! ❌");
            return; // Hentikan proses jika lebih dari 4 DEX
        }

        setTimeout(() => $InfoStatus.fadeOut(), 2000);

        $(".table-header th").css({
            "background-color": selectedChain.WARNA,
            "color": "white",
            "position": "sticky",
            "font-size":"12.5px",
            "top": "0",
            "font-weight": "bolder",
            "text-align": "center",
            "z-index": "10"
        });

        updateSortIcons();
    }

    //FUNGSI ubah status tokenpair
    $(document).on('change', '.statusCheckbox', function (event) {
        event.preventDefault();
        const id = $(this).data('id');
        const no = $(this).data('index');
        const isChecked = $(this).prop('checked');
        const storedData = getFromLocalStorage('TOKEN_SCANNER', []);
        const selectedCEX = getFromLocalStorage('CEX_PILIH', []); // Ambil selectedCEX dari localStorage
        const token = storedData.find(t => t.no === no);

        if (token) {
            token.status = isChecked;
            saveToLocalStorage('TOKEN_SCANNER', storedData);

            // Hitung ulang jumlah total token aktif
            const jml = storedData.filter(item => 
                item.status === true /* && 
                item.depositPair === true && 
                item.withdrawToken === true && 
                item.depositToken === true && 
                item.withdrawPair === true
                */
            ).length;

            $(`td[data-index="${id}"]`).remove();
            $('tr[data-index="' + id + '"]').hide();
            // Perbarui elemen yang menampilkan total ALL token
            $('#tokenCountALL').text(`TOTAL SEMUA : ${jml} PAIR-TOKEN`);

            // Hitung ulang jumlah token per CEX
            const savedCexs = [...new Set(storedData.map(t => t.cex))]; // Ambil daftar CEX unik
            const tokenCounts = savedCexs.reduce((acc, cex) => {
                acc[cex] = storedData.filter(t => t.cex === cex && t.status === true).length;
               /* && t.depositPair === true && t.withdrawToken === true && t.depositToken === true && t.withdrawPair === true).length;*/
                return acc;
            }, {});

            // Perbarui jumlah token dan status checkbox di cex-options
            savedCexs.forEach(cex => {
                const countText = ` (${tokenCounts[cex] || 0})`;
                const isCheckedCEX = selectedCEX.includes(cex); // Cek apakah cex termasuk dalam selectedCEX
                $(`#cex-options label:contains(${cex.toUpperCase()})`).each(function () {
                    const labelText = $(this).text().split('(')[0].trim(); // Ambil teks label sebelum tanda kurung
                    $(this).html(`
                        <input type="checkbox" value="${cex}" ${isCheckedCEX ? 'checked' : ''}>
                        ${labelText}${countText}
                    `);
                });
            });

            toastr.info(`Berhasil mengubah status PAIR ${token.symbol_in}-${token.symbol_out}!`);
        }
    });

    //generate url cex
    function GeturlExchanger(cex, NameToken, NamePair) {
        // Konversi nama token dan pasangan ke uppercase
        const token = NameToken.toUpperCase();
        const pair = NamePair.toUpperCase();

        let baseUrlTradeToken = token === "USDT" ? "#" : null;
        let baseUrlTradePair = pair === "USDT" ? "#" : null;
        let baseUrlWithdraw = null;
        let baseUrlDeposit = null;

        // Menentukan URL berdasarkan nilai cex
        if (cex === "GATE") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.gate.io/trade/${token}_USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.gate.io/trade/${pair}_USDT`;
            baseUrlWithdraw = `https://www.gate.io/myaccount/withdraw/${token}`;
            baseUrlDeposit = `https://www.gate.io/myaccount/deposit/${pair}`;
        } else if (cex === "BINANCE") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.binance.com/en/trade/${token}_USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.binance.com/en/trade/${pair}_USDT`;
            baseUrlWithdraw = `https://www.binance.com/en/my/wallet/account/main/withdrawal/crypto/${token}`;
            baseUrlDeposit = `https://www.binance.com/en/my/wallet/account/main/deposit/crypto/${pair}`;
        } else if (cex === "KUCOIN") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.kucoin.com/trade/${token}-USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.kucoin.com/trade/${pair}-USDT`;
            baseUrlWithdraw = `https://www.kucoin.com/assets/withdraw/${token}`;
            baseUrlDeposit = `https://www.kucoin.com/assets/coin/${pair}`;
        } else if (cex === "BITGET") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bitget.com/spot/${token}USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bitget.com/spot/${pair}USDT`;
            baseUrlWithdraw = `https://www.bitget.com/asset/withdraw`;
            baseUrlDeposit = `https://www.bitget.com/asset/recharge`;
        } else if (cex === "BYBIT") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bybit.com/en/trade/spot/${token}/USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bybit.com/en/trade/spot/${pair}/USDT`;
            baseUrlWithdraw = "https://www.bybit.com/user/assets/withdraw";
            baseUrlDeposit = "https://www.bybit.com/user/assets/deposit";
        } else if (cex === "MEXC") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.mexc.com/exchange/${token}_USDT?_from=search`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.mexc.com/exchange/${pair}_USDT?_from=search`;
            baseUrlWithdraw = `https://www.mexc.com/assets/withdraw/${token}`;
            baseUrlDeposit = `https://www.mexc.com/assets/deposit/${pair}`;
        } else if (cex === "OKX") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.okx.com/trade-spot/${token}-usdt`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.okx.com/trade-spot/${pair}-usdt`;
            baseUrlWithdraw = `https://www.okx.com/balance/withdrawal/${token}-chain`;
            baseUrlDeposit = `https://www.okx.com/balance/recharge/${pair}`;
        }

        // Kembalikan objek URL
        return {
            tradeToken: baseUrlTradeToken,
            tradePair: baseUrlTradePair,
            withdrawUrl: baseUrlWithdraw,
            depositUrl: baseUrlDeposit
        };
    }

    // Menampilkan form settingan
    $("#SettingModal").on("click", function () {
        UIkit.modal("#modal-setting").show(); // Menampilkan modal settingan
        let appSettings = getFromLocalStorage('DATA_SETTING', {}); // Ambil data pengaturan dari localStorage

        // Daftar DEX yang digunakan, diambil dari DTChain.DEXS
        const dexList = DTChain.DEXS || []; // Pastikan DTChain.DEXS ada, jika tidak gunakan array kosong
       // console.log(dexList);
        // Fungsi untuk memuat pengaturan ke dalam form
        function loadSettings() {
            // Gunakan fungsi generateInputModal untuk membuat input DEX
            generateInputModal(dexList);

            // Isi nilai modal DEX dari appSettings
            dexList.forEach((dex) => {
                const modalValue = appSettings[`MODAL_${dex.toUpperCase()}`] || "0";
                $(`#Modal${dex.toUpperCase()}`).val(modalValue); // Isi input dengan nilai yang sesuai
            });

            // Isi setting scanner
            $('#user').val(appSettings.nickname || ''); // Nickname
            $('#inFilterPNL').val(appSettings.filterPNL || 0); // Filter PNL
            $('#jeda-time-group').val(appSettings.jedaTimeGroup || 400); // Jeda Time Group
            $('#jeda-koin').val(appSettings.jedaKoin || 200); // Jeda Koin
            $('#walletMeta').val(appSettings.walletMeta || ''); // Wallet MetaMask
            $('#speedScan').val(appSettings.speedScan || 4); // Speed Scan

            // Pilih radio button sesuai nilai yang ada di setting
            $(`input[name="koin-group"][value="${appSettings.scanPerKoin || 10}"]`).prop('checked', true);
            $(`input[name="waktu-tunggu"][value="${appSettings.speedScan || 4}"]`).prop('checked', true);
        }

        // Panggil fungsi untuk memuat pengaturan
        loadSettings();
    });

    // simpan setingan
    $('#save-config').on('click', function() {
        let nickname = $('#user').val();
        let filterPNL = $('#inFilterPNL').val();
        let jedaTimeGroup = $('#jeda-time-group').val();
        let jedaKoin = $('#jeda-koin').val();
        let walletMeta = $('#walletMeta').val();

        if (!nickname || !filterPNL || !jedaTimeGroup || !jedaKoin || !walletMeta) {
            alert('SEMUA HARUS DIISI!');
            return;
        }

        let scanPerKoin = $('input[name="koin-group"]:checked').val();
        let speedScan = $('input[name="waktu-tunggu"]:checked').val();

        let dexData = {};
        DTChain.DEXS.forEach(dex => {
            let modalValue = $(`#Modal${dex.toUpperCase()}`).val();
            if (modalValue) {
                dexData[`MODAL_${dex.toUpperCase()}`] = modalValue;
            }
        });

        // Ambil data lama
        let oldData = getFromLocalStorage('DATA_SETTING', {});

        // Gabungkan data lama dan baru
        let appSettings = {
            ...oldData,
            ...dexData,
            nickname: nickname,
            filterPNL: filterPNL,
            jedaTimeGroup: jedaTimeGroup,
            jedaKoin: jedaKoin,
            walletMeta: walletMeta,
            scanPerKoin: scanPerKoin,
            speedScan: speedScan
        };

        saveToLocalStorage('DATA_SETTING', appSettings);

        UIkit.modal("#modal-setting").hide();
        alert("SIMPAN SETTING APLIKASI BERHASIL!!");
        location.reload();
    });

    $(document).on('change', '#cex-options input[type="checkbox"], #dex-options input[type="checkbox"], #dexpair-options input[type="checkbox"]', function() {
        // Menentukan kategori checkbox berdasarkan ID
        const groupName = $(this).closest('div[id^="cex-options"], div[id^="dex-options"], div[id^="dexpair-options"]').attr('id');
        let selectedValues = [];
        $(`#${groupName} input[type="checkbox"]:checked`).each(function() {
            selectedValues.push($(this).val());
        });

        // Tentukan key lokalStorage berdasarkan groupName
        const localStorageKeyMap = {
            'cex-options': 'CEX_PILIH',
            'dex-options': 'DEX_PILIH',
            'dexpair-options': 'DEXPAIR_PILIH'
        };
        const localStorageKey = localStorageKeyMap[groupName];

        if (localStorageKey) {
            saveToLocalStorage(localStorageKey, selectedValues);  // Simpan ke localStorage
            UIkit.notification(`SETTING APLIKASI ${groupName.toUpperCase()} menjadi ${selectedValues.join(', ')} !`, { status: 'success' });
        }

        // Memanggil fungsi filter dan reload data
        const filteredTokens = filterTokens(selectedValues);  // Pastikan filterTokens menerima nilai yang difilter
        console.log("TOKEN TERFILTER ",filteredTokens);
        loadStoredData(filteredTokens); 
        
        location.reload()
        // Memuat data yang sudah difilter
    });

    // Fungsi untuk mengurutkan tabel
    function sortTable(columnIndex) {
        const rows = $('#dataTableBody tr').get();

        rows.sort(function(a, b) {
            const keyA = $(a).children('td').eq(columnIndex).text().toUpperCase();
            const keyB = $(b).children('td').eq(columnIndex).text().toUpperCase();

            if (sortOrder[columnIndex] === undefined) {
                sortOrder[columnIndex] = true; // Default ke urutan naik
            }

            if (keyA < keyB) return sortOrder[columnIndex] ? -1 : 1;
            if (keyA > keyB) return sortOrder[columnIndex] ? 1 : -1;
            return 0;
        });

        // Kosongkan tabel dan tambahkan kembali baris yang sudah diurutkan
        $('#dataTableBody').empty().append(rows);

        // Update kolom No agar tetap berurutan
        $('#dataTableBody tr').each((index, row) => {
            $(row).children('td').first().text(index + 1); // Set nomor berurutan
        });

        // Toggle urutan untuk kolom yang sama
        sortOrder[columnIndex] = !sortOrder[columnIndex];
        updateSortIcons();
    }

    // Memperbarui ikon urutan
    function updateSortIcons() {
        $('.sort-icon').html(''); // Reset semua ikon
        for (let index in sortOrder) {
            const icon = sortOrder[index] ? '▲' : '▼';
            $('#sortIcon' + index).html(icon);
        }
    }

    //fungsi generate setting modal untuk DEX
    function generateInputModal(dexList) {
        const container = $('#modal-container');
        container.empty(); // Bersihkan container
        dexList.forEach(dex => {
            // Mengubah nama dex menjadi huruf besar
            const dexUpperCase = dex.toUpperCase();
            // Membuat heading
            const heading = $('<h5></h5>')
                .css({ 'margin': '8px 0px', 'color': '#e4322c' })
                .text(`Modal ${dexUpperCase}`);
            
            container.append(heading);

            // Membuat modal div
            const modalDiv = $('<div></div>');
            // Input modal
            const modalInput = $('<input>')
                .attr('type', 'number')
                .attr('id', `Modal${dexUpperCase}`)
                .addClass('uk-input')
                .val('0')
                .attr('required', true);
            // Tambahkan label dan input ke modal div
            modalDiv.append(modalInput);

            // Tambahkan modal div ke container
            container.append(modalDiv);
        });
    }

    // Fungsi untuk memproses data order book exchanger
    function processOrderBook(data) {
        const priceBuy = data.bids.slice(0, 3).map(([price, volume]) => ({
            price: parseFloat(price),
            volume: parseFloat(volume) * parseFloat(price) // Volume dalam USD
        })).reverse(); // Membalik urutan priceBuy

        const priceSell = data.asks.slice(0, 3).map(([price, volume]) => ({
            price: parseFloat(price),
            volume: parseFloat(volume) * parseFloat(price) // Volume dalam USD
        })).reverse(); // Membalik urutan priceSell

        return { priceBuy, priceSell };
    }

    // fungsi dapatkan harga token dari Exchanger
    function getPriceCEX(coins, NameToken, NamePair, cex, callback) {
        const config = exchangeConfig[cex];
        if (!config) {
            callback(`Exchange ${cex} tidak ditemukan dalam konfigurasi.`, null);
            return;
        }

        const feeList = getFromLocalStorage("TOKEN_SCANNER", []);
        if (!Array.isArray(feeList) || feeList.length === 0) {
            toastr.error("PERIKSA ULANG FEE WD dari EXCHANGER !!");
            callback("Token scanner belum diatur.", null);
            return;
        }

        const tokenData = feeList.find(item => item.symbol_in === NameToken && item.symbol_out === NamePair && item.cex === cex);
        
        const isStablecoin = (token) => stablecoins.includes(token);
        let results = {};

        const urls = [
            isStablecoin(NameToken) ? null : config.url({ symbol: NameToken }),
            isStablecoin(NamePair) ? null : config.url({ symbol: NamePair })
        ];

        const processFinalResult = () => {
            if (Object.keys(results).length === 2) { 
                const priceBuyToken = results[NameToken]?.price_buy || 0;
                const priceBuyPair = results[NamePair]?.price_buy || 0;

                const feeWDToken = parseFloat(tokenData.feeWDToken) * priceBuyToken;
                const feeWDPair = parseFloat(tokenData.feeWDPair) * priceBuyPair;

                if (isNaN(feeWDToken) || feeWDToken < 0) {
                    callback(`FeeWD untuk ${NameToken} di ${cex} tidak valid: ${feeWDToken}`, null);
                    return;
                }
                if (isNaN(feeWDPair) || feeWDPair < 0) {
                    callback(`FeeWD untuk ${NamePair} di ${cex} tidak valid: ${feeWDPair}`, null);
                    return;
                }

                const finalResult = {
                    token: NameToken.toUpperCase(),
                    sc_input: coins.sc_in,
                    sc_output: coins.sc_out,
                    pair: NamePair.toUpperCase(),
                    cex: cex.toUpperCase(),
                    price_sellToken: results[NameToken].price_sell,
                    price_buyToken: priceBuyToken,
                    price_sellPair: results[NamePair].price_sell,
                    price_buyPair: priceBuyPair,
                    volumes_sellToken: results[NameToken].volumes_sell,
                    volumes_buyToken: results[NameToken].volumes_buy,
                    volumes_sellPair: results[NamePair].volumes_sell,
                    volumes_buyPair: results[NamePair].volumes_buy,
                    feeWDToken: feeWDToken,
                    feeWDPair: feeWDPair
                };

                updateTableVolCEX({}, finalResult, cex);
                callback(null, finalResult);
            }
        };

        urls.forEach((url, index) => {
            const tokenName = index === 0 ? NameToken : NamePair;
            if (isStablecoin(tokenName)) {
                results[tokenName] = {
                    price_sell: 1,
                    price_buy: 1,
                    volumes_sell: [{ price: 1, volume: 10000 },{ price: 1, volume: 10000 },{ price: 1, volume: 10000 }],
                    volumes_buy: [{ price: 1, volume: 10000 },{ price: 1, volume: 10000 },{ price: 1, volume: 10000 }]
                };
                processFinalResult();
                return;
            }

            if (url) {
                $.ajax({
                    url: url,
                    method: 'GET',
                    success: function (data) {
                        let processedData;
                        try {
                            processedData = config.processData(data);
                        } catch (error) {
                            console.error(`Error processing data untuk ${tokenName} di ${cex}:`, error);
                            callback(`Error processing data untuk ${tokenName} di ${cex}.`, null);
                            return;
                        }

                        const priceBuy = processedData.priceSell[2]?.price || null;
                        const priceSell = processedData.priceBuy[2]?.price || null;

                        if (priceBuy === null || priceSell === null) {
                            callback(`Harga buy/sell untuk ${tokenName} di ${cex} tidak tersedia.`, null);
                            return;
                        }

                        results[tokenName] = {
                            price_sell: priceSell,
                            price_buy: priceBuy,
                            volumes_sell: processedData.priceBuy,
                            volumes_buy: processedData.priceSell
                        };

                        processFinalResult();
                    },
                    error: function (xhr) {
                        const errorMessage = xhr.responseJSON?.msg || "Unknown ERROR";
                        callback(`Error koneksi API untuk ${tokenName} di ${cex}: ${errorMessage}`, null);
                    }
                });
            }
        });
    }


    // Fungsi update price & vol untuk token dan pair
   function updateTableVolCEX(processedData, finalResult, cex) {
        const cexName = cex.toUpperCase();
        const TokenPair = finalResult.token + "_" + finalResult.pair;
        
        $('#LEFT_' + cexName + '_' + TokenPair+'_'+ (DTChain.Nama_Chain).toUpperCase()).html(
                finalResult.volumes_buyToken.map((data, index) => {
                    return `<span class='uk-text-success'>${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/></span>`;
                }).join('') +
                `<span class='uk-text-secondary uk-text-bolder'>${finalResult.token} -> ${finalResult.pair}</span><br/>`+
               // <span class='uk-text-primary uk-text-bolder'>FeeWD: ${finalResult.feeWDToken}</span><br/>` + 
                finalResult.volumes_sellPair.reverse().map((data, index) => {
                    return `<span class='uk-text-danger'>${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/></span>`;
                }).join('')       
        );

        $('#RIGHT_' + cexName + '_' + TokenPair+'_'+ (DTChain.Nama_Chain).toUpperCase()).html(
                finalResult.volumes_buyPair.map((data, index) => {
                    return `<span class='uk-text-success'>${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/></span>`;
                }).join('')+
                `<span class='uk-text-secondary uk-text-bolder'>${finalResult.pair} -> ${finalResult.token}</span><br/>` + 

                finalResult.volumes_sellToken.reverse().map((data, index) => {
                    return `<span class='uk-text-danger'>${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/></span>`;
                }).join('')                 
        );
    }

    // list api OKXDEX sell_BINANCE_USDT_buy_0x_BAL
    const apiKeysOKXDEX = [
        
        {
            ApiKeyOKX: "47953eea-d5aa-43f9-9d56-34966978d693",
            secretKeyOKX: "11C0BD3536C759C5A5E5F7A70077A483",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "22747ba1b56f9da3a7c10140cb95ffa5"
        },{
            ApiKeyOKX: "fb673273-7b7e-4857-b30d-316e5600e13c",
            secretKeyOKX: "C6F812C9670DE4327408BB21B09F38BC",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "ebb6d5612181cb993230ca49c7b50cb8"
        },{
            ApiKeyOKX: "6db77592-fb30-466e-ae0e-c7f3ae15ce7c",
            secretKeyOKX: "BAFD1D91B6D359DCB92629FD44852307",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "df27a64d6c0130624609cc5b56c274d0"
        },{
            ApiKeyOKX: "9ed6219f-980c-417a-a544-055c937b4296",
            secretKeyOKX: "17CEA820AF94463DB8AC6AEC283287D0",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "c95a51b2e06febfbe3976621beb95975"
        },{
            ApiKeyOKX: "7540524b-85a7-440b-84e4-f71280ec8919",
            secretKeyOKX: "A992D6F2890740F8509587868C8A37A3",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "55b213a813f3fd8080a209acdc4aec9b"
        },{
            ApiKeyOKX: "46df841b-4e72-4f3f-a91c-1d1a9b315708",
            secretKeyOKX: "DA06455105A85C3F770C6E01AC42F9DA",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "3174e031e2d03982662688a2734d542e"
        },{
            ApiKeyOKX: "3a3e9296-6c13-4562-84d8-7f4824fb7ac7",
            secretKeyOKX: "1DD3C44F3CA652D4478F739E15C84515",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "9c6ae2d2465046deb6e2965b28a07c42"
        },{
            ApiKeyOKX: "d675d069-4054-4932-a8b1-303b981b8124",
            secretKeyOKX: "2D957A6AAFA1DB1D521296FB0D89F151",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "54e89c9d24d9fb531c527661c84f42dc"
        },{
            ApiKeyOKX: "32ecce69-add4-4fda-984e-7cb34a22797f",
            secretKeyOKX: "5FB9974EA1AC161A27DB68BA51531534",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "35379ea55673bc3516eb8026539be558"
        },{
            ApiKeyOKX: "cccd8b36-a09a-4578-9837-48135f0ff230",
            secretKeyOKX: "EEA4E6EE19EBCDB8CD59F52A9FC8B3CD",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "bab376dfe9e2815c5902e7694bed486e"
        },{
            ApiKeyOKX: "8a059b63-002c-471d-b495-5e55b15bf12a",
            secretKeyOKX: "CAC05FFFD91F84230AA5E8BA0E06B172",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "df1bcaf4acca274c769fc170a7f9dcbb"
        },{
            ApiKeyOKX: "75b75f5e-dbd3-4948-a5ce-77af8871e6ac",
            secretKeyOKX: "5D9F841F0B57E8D51DC574EBE487748C",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "ca2ed1bae58cacd15cf1006a933a2c94"
        },{
            ApiKeyOKX: "54aa3296-d6ab-4873-a5bb-b00d2b006015",
            secretKeyOKX: "971AC2D6264E45F895D446D878B55AE4",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "7304207d79c2df4956d5fdd9f1afc2c2"
        },{
            ApiKeyOKX: "3f6b0085-2d3a-4fc0-8917-a555d1cd259c",
            secretKeyOKX: "68A12A595AA5EA5EFC03DDBAD452DBD6",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "591778696ad3438a4266b0bbd6297d2e"
        },{
            ApiKeyOKX: "3b96a61f-68fd-4d4c-94d9-ff357ef2fb83",
            secretKeyOKX: "3E29ED11AF70FCC530C39948BFAA2405",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "0fbd7084efbd79e915f99701aa989c28"
        },{
            ApiKeyOKX: "94e7d78e-708f-48ff-814d-70a1f3e6fd49",
            secretKeyOKX: "2FD013E26D1309B2B532407FFD4BC097",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "8607ef99dc6e31a80e21b16f914a0f18"
        },
       
        
      ];
      
       // Fungsi untuk Signature
    function calculateSignature(exchange, apiSecret, dataToSign, hashMethod = "HmacSHA256") {
        if (!apiSecret || !dataToSign) {
            console.error(`[${exchange}] API Secret atau Data untuk Signature tidak valid!`);
            return null;
        }
    
        switch (exchange.toUpperCase()) {
            case "MEXC":
            case "BINANCE":
            case "KUCOIN":
            case "BYBIT":
                // Gunakan HMAC-SHA256
                return CryptoJS[hashMethod](dataToSign, apiSecret).toString(CryptoJS.enc.Hex);
    
            case "OKX":
                // Gunakan BASE64 untuk OKX
                const hmac = CryptoJS.HmacSHA256(dataToSign, apiSecret);
                return CryptoJS.enc.Base64.stringify(hmac);
    
            default:
                console.error(`[${exchange}] Exchange tidak didukung untuk perhitungan signature.`);
                return null;
        }
    } 
    
      // Fungsi untuk mendapatkan kredensial API secara acak
      function getRandomApiKeyOKX() {
        const randomIndex = Math.floor(Math.random() * apiKeysOKXDEX.length);
        return apiKeysOKXDEX[randomIndex];
      }

      function ResultEksekusi(amount_out,FeeSwap,sc_input, sc_output, cex, Modal, amount_in, priceBuyToken_CEX, priceSellToken_CEX, priceBuyPair_CEX, priceSellPair_CEX, Name_in, Name_out, feeWD, dextype, trx) {
        var NameX = Name_in+"_"+Name_out;  
        var amount_out = Number(amount_out);
        var FeeSwap = parseFloat(FeeSwap);
        var FeeWD = parseFloat(feeWD);
        var FeeTrade = parseFloat(0.0014 * Modal);
        
        // Hitung Harga Rata-rata
        var rateSellTokenDEX = (amount_out * priceSellPair_CEX) / amount_in; // Harga rata-rata jual Name_in di DEX
        var rateBuyPairDEX = (amount_in * priceBuyToken_CEX) / amount_out;
        var rateTokentoPair = amount_out / amount_in; // Menghitung rate MDT per BNT atau per jumlah yang dibeli

        // Hitung Nilai Akhir dan P&L
        var totalModal = Modal + FeeSwap + FeeWD + FeeTrade; // Modal awal (USDT)
        var totalFee = FeeSwap + FeeWD + FeeTrade; // Total biaya (USDT)
        var totalValue = amount_out * priceSellPair_CEX; // Nilai akhir (USDT)
        var profitLoss = totalValue - totalModal; // Profit or Loss (USDT)
        var profitLossPercent = totalModal !== 0 ? (profitLoss / totalModal) * 100 : 0; // Profit or Loss (%)
        var filterPNLValue = parseFloat(SavedSettingData.filterPNL);
        // == 0 ? totalFee + (Modal * 0.2 / 100) : parseFloat(SavedSettingData.FilterPNL);
        
        var conlusion="NO SELISIH";
        var selisih =false;
            // Jika filter PNL adalah 0, bandingkan nilai akhir dengan modal + semua biaya
            if (filterPNLValue == 0) {
                if (totalValue > totalModal + totalFee) {
                    conlusion = "GET SIGNAL";
                    selisih=true;
                }
            }
            // Jika filter PNL bukan 0, bandingkan selisih nilai akhir dan modal dengan filter PNL
            else {
                if ((totalValue - totalModal) > filterPNLValue) {
                    conlusion = "GET SIGNAL";
                    selisih=true;
                }
            }         // Output log
            
                let IdCELL = `${cex.toUpperCase()}_${dextype.toUpperCase()}_${NameX}_${(DTChain.Nama_Chain).toUpperCase()}`;
                var linkDEX = generateDexLink(dextype.toLowerCase(), Name_in, sc_input, Name_out, sc_output);

            if (!linkDEX) {
                console.error(`DEX Type "${dexType}" tidak valid atau belum didukung.`);
                return;
            }
            if (stablecoins.includes(Name_in)) {
                var RateSwap = `<label class="uk-text-success" title="DEX ${dextype.toUpperCase()} : ${formatPrice(rateBuyPairDEX)}(${Name_in}->${Name_out})"> ${formatPrice(rateBuyPairDEX)}</label>`;
            } else if (stablecoins.includes(Name_out)) {
                var RateSwap = `<label class="uk-text-danger" title="DEX ${dextype.toUpperCase()} : ${formatPrice(rateTokentoPair)} (${Name_in}->${Name_out})"> ${formatPrice(rateTokentoPair)}</label>`;
            } else {
                var RateSwap = `<label class="uk-text-primary" title="DEX ${dextype.toUpperCase()} : ${formatPrice(rateSellTokenDEX)} ${Name_in} ${formatPrice(rateBuyPairDEX)} ${Name_out}">${formatPrice(rateTokentoPair)}</label>`;
            }   
         // Cek apakah elemen dengan ID ada di DOM
            if ($(`#SWAP_${IdCELL}`).length > 0) {
                $(`#SWAP_${IdCELL}`).html(`<a href="${linkDEX}" target="_blank">  ${RateSwap} `);           
            }

            DisplayPNL( profitLoss,  cex,  Name_in, NameX, totalFee, Modal, dextype, priceBuyToken_CEX, rateSellTokenDEX, FeeSwap, FeeWD, sc_input, sc_output, Name_out,totalValue,totalModal,conlusion,selisih,trx,profitLossPercent);
            
    }

     // Fungsi INFO SINYAL
     function DisplayPNL(PNL, cex, Coin_in, NameX, totalFee, modal, dex, priceCEX, priceDEX, FeeSwap, FeeWD, sc_input, sc_output, Coin_out, totalValue, totalModal, conclusion, selisih, trx, profitLossPercent) {
       // console.log('trx',trx)
        var filterPNLValue = parseFloat(SavedSettingData.filterPNL);
        var nickname = SavedSettingData.nickname;
        var totalValue = parseFloat(totalValue);
        var totalGet = totalValue - parseFloat(modal);
        var totalModal = parseFloat(totalModal);
        var totalFee = parseFloat(totalFee);

        const urlsCEXToken = GeturlExchanger(cex.toUpperCase(), Coin_in, Coin_out);
      //  const urlsCEXPair = GeturlExchanger(cex.toUpperCase(), Coin_out, Coin_out);

        // Mencari token yang sesuai dalam datatokens
        var buyLink = GeturlExchanger(cex.toUpperCase(), Coin_in, Coin_out).tradeToken;
        var sellLink = GeturlExchanger(cex.toUpperCase(), Coin_in, Coin_out).tradePair;

        var IdCELL = `${cex.toUpperCase()}_${dex.toUpperCase()}_${NameX}_${(DTChain.Nama_Chain).toUpperCase()}`;
        var resultCell = $(`#RESULT_${IdCELL}`);
        var buyCell = $(`#LEFT_${IdCELL}`);
        var sellCell = $(`#RIGHT_${IdCELL}`);
        var rowCell = $(`#${IdCELL}`);

        var sinyals = ` <a href="#SWAP_${cex.toUpperCase()}_${dex.toUpperCase()}_${NameX}_${(DTChain.Nama_Chain).toUpperCase()}" class='link-class'>
            ${cex.toUpperCase()} VS ${dex.toUpperCase()} : ${NameX} (${PNL.toFixed(2)}$)</a> `;

        var isPositivePNL = (filterPNLValue === 0 && totalValue > totalModal) || ((totalValue - totalModal) > filterPNLValue);

        if (isPositivePNL) {
           // if(trx==='TokentoPair'){
                var tokenData = DataTokens.find(t => t.cex === cex.toUpperCase() && t.symbol_in === Coin_in && t.symbol_out === Coin_out);

                var withdraw = tokenData.withdrawToken ? createLink(urlsCEXToken.withdrawUrl, 'WD') : `<b style="color:red; font-weight:bold;">WX</b>`;
                var deposit = tokenData.depositPair ? createLink(urlsCEXToken.depositUrl, 'DP') : `<b style="color:red; font-weight:bold;">DX</b>`;
            // }else{    
            //     var tokenData = DataTokens.find(t => t.cex === cex.toUpperCase() && t.symbol_in === Coin_out && t.symbol_out === Coin_in);

            //     var withdraw = tokenData.withdrawPair ? createLink(urlsCEXPair.withdrawUrl, 'WD') : `<b style="color:red; font-weight:bold;">WX</b>`;
            //     var deposit = tokenData.depositToken ? createLink(urlsCEXToken.depositUrl, 'DP') : `<b style="color:red; font-weight:bold;">DX</b>`;
            // }    
            toastr.success(sinyals);
            rowCell.css({ 'background-color': '#c2f890', 'font-weight': 'bolder' });
                resultCell.html(`
                <span class="uk-text-secondary"> ${withdraw} [${FeeWD.toFixed(2)}$] ~ ${deposit}</span><br/>
                    <span class="uk-text-danger">All:${totalFee.toFixed(2)}$</span>
                    <span class="uk-text-primary">SW:${FeeSwap.toFixed(2)}$</span> <br/>
                    <span class="uk-text-secondary">GT:${totalGet.toFixed(2)}$</span>
                    <span class="uk-text-secondary">PNL:${PNL.toFixed(2)}$ </span>
                `);

            if (!buyCell.parent().is("span")) {
                buyCell.wrap('<a href="' + buyLink + '" target="_blank"></a>');
            }
            if (!sellCell.parent().is("span")) {
                sellCell.wrap('<a href="' + sellLink + '" target="_blank"></a>');
            }

            InfoSinyal(dex.toLowerCase(), NameX, PNL, totalFee, cex.toUpperCase(), Coin_in, Coin_out,profitLossPercent);
        } else {
            resultCell.html(`
                <span class="uk-text-secondary" title="FEE WD CEX">FeeWD : ${FeeWD.toFixed(2)}$</span><br/>
                <span class="uk-text-danger" title="FEE ALL">ALL:${totalFee.toFixed(2)}$</span>
                <span class="uk-text-primary" title="FEE SWAP"> ${FeeSwap.toFixed(2)}$</span><br/>
                <span class="uk-text-success" title="GET BRUTO">Get:${totalGet.toFixed(2)}$</span>
                <span class="uk-text-secondary" title="GET NETTO / PNL" > ${PNL.toFixed(2)}$</span>
            `);
        }

        if (PNL > 1) {
            MultisendMessage(cex, dex.toUpperCase(), Coin_in, Coin_out, modal, PNL, priceCEX, priceDEX, FeeSwap, FeeWD, totalFee, nickname, sc_input, sc_output);
        }
    }

    // Fungsi untuk menampilkan sinyal hasil scan dan memutar suara
    function InfoSinyal(DEXPLUS, TokenPair, PNL, totalFee, cex, NameToken, NamePair,profitLossPercent) {
        // Menentukan warna teks berdasarkan `cex` menggunakan fungsi getWarnaCEX
        var warnaCEX = getWarnaCEX(cex);
        let idCELL = `${cex.toUpperCase()}_${DEXPLUS.toUpperCase()}_${NameToken}_${NamePair}_${(DTChain.Nama_Chain).toUpperCase()}`;
        
        // Membuat link dengan format umum tanpa pengecekan kondisi
        var sLink = `<a href=#SWAP_${idCELL} class='buy'>
            ${NameToken}->${NamePair} <span class="uk-text-secondary"> ${profitLossPercent.toFixed(1)}% </span>
            (<span style='color:${warnaCEX}; font-weight:bolder;'>${cex.toUpperCase()}:</span><span class="uk-text-primary">${PNL.toFixed(2)}$ </span>)
        </a>`;

        // Menambahkan link ke elemen dengan ID yang sesuai
        $("#sinyal" + DEXPLUS.toLowerCase()).append(` ${sLink} |`);
        
        var audio = new Audio('audio.mp3');  // Ganti dengan path file suara yang sesuai
        audio.play();
    }

    // Fungsi untuk mengecek harga pada DEX  
    function generateDexLink(dex, NameToken, sc_input, NamePair, sc_output) {
        const link = {
            'kyberswap': `https://kyberswap.com/swap/${DTChain.Nama_Chain}/${sc_input}-to-${sc_output}`,
            'kana': `https://app.paraswap.xyz/#/swap/${sc_input}-${sc_output}?version=6.2&network=${DTChain.Nama_Chain}`,
            'odos': "https://app.odos.xyz",
            '0x': `https://matcha.xyz/tokens/${DTChain.Nama_Chain}/${sc_input.toLowerCase()}?buyChain=${DTChain.Kode_Chain}&buyAddress=${sc_output.toLowerCase()}`,
            '1inch': `https://app.1inch.io/#/${DTChain.Kode_Chain}/advanced/swap/${sc_input}/${sc_output}`,
            'okx': `https://www.okx.com/web3/dex-swap?inputChain=${DTChain.Kode_Chain}&inputCurrency=${sc_input}&outputChain=501&outputCurrency=${sc_output}`,
            'magpie': `https://app.magpiefi.xyz/swap/${DTChain.Nama_Chain.toLowerCase()}/${NameToken.toUpperCase()}/${DTChain.Nama_Chain.toLowerCase()}/${NamePair.toUpperCase()}`,
            'paraswap': `https://app.paraswap.xyz/#/swap/${sc_input}-${sc_output}?version=6.2&network=${DTChain.Nama_Chain}`,
            'openocean' : `https://app.openocean.finance/swap/${DTChain.Nama_Chain}/${sc_input}/${sc_output}`,
            'jupiter': `https://jup.ag/swap/${sc_input}-${sc_output}`
        };

        return link[dex] || null;
    }

    function getPriceDEX(sc_input_in, des_input, sc_output_in, des_output, amount_in, PriceRate,  dexType, NameToken, NamePair, cex,action, callback) {
        var sc_input=sc_input_in.toLowerCase();
        var sc_output=sc_output_in.toLowerCase();
        var dexId = `${cex}_${dexType.toUpperCase()}_${NameToken}_${NamePair}_${(DTChain.Nama_Chain).toUpperCase()}`;
        var SavedSettingData = getFromLocalStorage('DATA_SETTING', {});
        var selectedApiKey = getRandomApiKeyOKX();
        var amount_in = BigInt(Math.round(Math.pow(10, des_input) * amount_in));
        var apiUrl, requestData,headers;   
        let normalizedNamePair = NamePair === "ETH" ? "WETH" :
                                NamePair === "BNB" ? "WBNB" :
                                NamePair === "POL" ? "WPOL" :
                                NamePair === "SOL" ? "WSOL" :
                                NamePair === "AVAX" ? "WAVAX" :
                                NamePair;
        var linkDEX = generateDexLink(dexType, NameToken, sc_input, NamePair, sc_output);
        // Mapping chainId untuk Kana
        const KanaChainID = {
            'solana': 1,
            'polygon': 3,
            'bsc': 4,
            'ethereum': 6,
            'Avalanche': 10,
            'Arbitrum': 11,
        };

        switch (dexType) {
            case 'kyberswap':
                let NetChain;
                if (DTChain.Nama_Chain.toUpperCase() === "AVAX") {
                    NetChain = "avalanche";
                }else{
                    NetChain=DTChain.Nama_Chain;
                }
                
                apiUrl = "https://aggregator-api.kyberswap.com/" + NetChain.toLowerCase() + "/api/v1/routes?tokenIn=" + sc_input + "&tokenOut=" + sc_output + "&amountIn=" + amount_in+ "&gasInclude=true";
                break;
            case 'odos':
                apiUrl = "https://api.odos.xyz/sor/quote/v2";               
                requestData = {
                    chainId: DTChain.Kode_Chain,
                    compact: true,
                    disableRFQs: true,
                    userAddr: "0xDb954A050D442E488fe24b0a3250170223AAB2e4",
                    inputTokens: [{ amount: amount_in.toString(), tokenAddress: sc_input }],
                    outputTokens: [{ proportion: 1, tokenAddress: sc_output }],
                    slippageLimitPercent: 0.3,
                };                
                break;
            case 'altodos':
                apiUrl = "https://ethmainnet.server.hinkal.pro/OdosSwapData";               
                requestData = {
                    chainId: DTChain.Kode_Chain,
                    compact: true,
                    disableRFQs: true,
                    userAddr: "0xDb954A050D442E488fe24b0a3250170223AAB2e4",
                    inputTokens: [{ amount: amount_in.toString(), tokenAddress: sc_input }],
                    outputTokens: [{ proportion: 1, tokenAddress: sc_output }],
                    slippageLimitPercent: 0.3,
                };                
                break;
            case '0x':           
                    apiUrl = selectedServer+"https://app.unidex.exchange/api/0x/quote?chainId="+DTChain.Kode_Chain+"&buyToken=" + sc_output + "&sellToken=" + sc_input + "&sellAmount=" + amount_in +"&taker="+SavedSettingData.walletMeta;
                    break;
            case '1inch':
                    apiUrl = "https://api-defillama.1inch.io/v6.0/" + DTChain.Kode_Chain + "/quote?src=" + sc_input + "&dst=" + sc_output + "&amount=" + amount_in + "&includeGas=true";
                break;
            case 'magpie':
                if(DTChain.Nama_Chain.toLowerCase() === 'bsc'){
                     apiUrl = "https://api.magpiefi.xyz/aggregator/quote?network=" + DTChain.Nama_Chain + "&fromTokenAddress=" + sc_input + "&toTokenAddress=" + sc_output + "&sellAmount=" + amount_in + "&gasless=true&slippage=0.1"+
                     "&liquiditySources=pancakeswap-v2%2Cmdex%2Cbakeryswap%2Cbiswap%2Capeswap%2Cbabyswap%2Cjetswap%2Cjulswap%2Cwardenswap%2Cacsiswap-stable%2Cacsiswap-weighted%2Cuniswap-v3%2Ctrident-stable%2Ctrident-constant-product%2Ckyber-swap-classic-static%2Ckyber-swap-classic-dynamic%2Csushi%2Ctrader-joe%2Celk-finance%2Cbaby-doge-swap%2Cw3-swap%2Cthena-fusion%2Cnomiswap-v3%2Chashflow-v3%2Cwoo-fi%2Cwombat%2Cthena-stable%2Cthena-volatile%2Ctrader-joe-v2-1%2Cradio-shack-swap%2Carchly-stable%2Carchly-volatile%2Csushi-v3%2Cnomiswap%2Csynapse%2Clif3-swap%2Ckapinus%2Cben-swap%2Cplanet%2Cknight-swap%2Calita-finance%2Ccoin-swap%2Cdinosaur-eggs%2Ckyoto-swap%2Cpanther-swap%2Ci-swap-v2%2Chyper-jump%2Cpad-swap%2Cnative%2Cpancakeswap-v3%2Ca-crypto-s%2Cellipsis-stable%2Ca-crypto-s-lp%2Cellipsis-stable-lp%2Cellipsis-crypto%2Cellipsis-crypto-lp%2Cmaverick%2Cpancakeswap-stable%2Cpancakeswap-stable-lp%2Cpancakeswap-v2-lp%2Cmdex-lp%2Cbakeryswap-lp%2Cbiswap-lp%2Capeswap-lp%2Cbabyswap-lp%2Cjetswap-lp%2Cjulswap-lp%2Cwardenswap-lp%2Csushi-lp%2Ctrader-joe-lp%2Celk-finance-lp%2Cbaby-doge-swap-lp%2Cw3-swap-lp%2Cradio-shack-swap-lp%2Cnomiswap-lp%2Clif3-swap-lp%2Ckapinus-lp%2Cben-swap-lp%2Cplanet-lp%2Cknight-swap-lp%2Calita-finance-lp%2Ccoin-swap-lp%2Cdinosaur-eggs-lp%2Ckyoto-swap-lp%2Cpanther-swap-lp%2Ci-swap-v2-lp%2Chyper-jump-lp%2Cpad-swap-lp%2Cspartan%2Csmar-dex%2Cmaverick-v2%2Cbebop%2Cbeefy%2Cswaap-v2%2Celk-finance-v3%2Cyield-nest-max-lrt-vault%2Cerc-4626%2Cuniswap-v2%2Cuniswap-v2-lp%2Cizi-swap";
                 }else if(DTChain.Nama_Chain.toLowerCase() === 'ethereum'){
                     apiUrl = "https://api.magpiefi.xyz/aggregator/quote?network=" + DTChain.Nama_Chain + "&fromTokenAddress=" + sc_input + "&toTokenAddress=" + sc_output + "&sellAmount=" + amount_in + "&gasless=true&slippage=0.1"+
                     "&liquiditySources=sushi,balancer-v2-stable,balancer-v2-weighted,curve-crypto,curve-stable,defi-swap,lua-swap,sake-swap,shibaswap,uniswap-v3,curve-crypto2,dodo-v2-stable,dodo-v2-private,verse-dex,kyber-swap-classic-static,kyber-swap-classic-dynamic,integral-size,apeswap,elk-finance,pancakeswap-v2,hashflow-v3,saddle-base,saddle-meta,trader-joe-v2-1,radio-shack-swap,sushi-v3,solidly-v2-stable,solidly-v2-volatile,synapse,aave-v2,aave-v3,capital-dex,native,curve-crypto-lp,curve-stable-lp,curve-crypto2-lp,pancakeswap-v3,dodo-v2-vending-manchine,swapr,synthetix,synthetix-lp,swaap-v2,clipper,bancor-v2-1,smoothy-v1,solidly-v3,lido,maverick,defi-plaza,gyroscope-2clp,gyroscope-3clp,gyroscope-eclp,sushi-lp,uniswap-v2-lp,defi-swap-lp,lua-swap-lp,sake-swap-lp,shibaswap-lp,verse-dex-lp,apeswap-lp,elk-finance-lp,pancakeswap-v2-lp,radio-shack-swap-lp,capital-dex-lp,swapr-lp,bedrock,psm-usdc,wagmi,smar-dex,dfx-v2,dfx-v3,maverick-v2,bebop,beefy,rings-usdc,rings-eth,elk-finance-v3,wombat,yield-nest-nlrt,balancer-v3-stable,balancer-v3-weighted,erc-4626,liquid-move-eth";
                 }else{
                    apiUrl = "https://api.magpiefi.xyz/aggregator/quote?network=" + DTChain.Nama_Chain + "&fromTokenAddress=" + sc_input + "&toTokenAddress=" + sc_output + "&sellAmount=" + amount_in + "&gasless=false&slippage=0.2";
                 }
                 //

                 break; 
            case 'kana':
                    // Mapping chainId dari DTChain.Nama_Chain ke KanaChainID
                const chainName = DTChain.Nama_Chain.toLowerCase();
                const kanaChainId = KanaChainID[chainName];

                if (!kanaChainId) {
                    apiUrl = "https://api.paraswap.io/prices?" + "srcToken=" + sc_input + "&srcDecimals=" + des_input + "&destToken=" + sc_output + "&destDecimals=" + des_output + "&side=SELL&network=" + DTChain.Kode_Chain + "&amount=" + amount_in + "&version=6.2";
                }

                // Endpoint untuk Kana
                apiUrl = `https://ag.kanalabs.io/v1/swapQuote?inputToken=${sc_input}&outputToken=${sc_output}&chain=${kanaChainId}&amountIn=${amount_in.toString()}&slippage=0.5&isFeeReferrer=false`;
                break;
            case 'okx':
                var queryString = `/api/v5/dex/aggregator/quote?amount=${amount_in}&chainId=${DTChain.Kode_Chain}` + `&fromTokenAddress=${sc_input}&toTokenAddress=${sc_output}`;
                var timestamp = new Date().toISOString();
                var method = "GET";
                var dataToSign = timestamp + method + queryString;
                apiUrl = `https://www.okx.com${queryString}`;

                var signature = calculateSignature("OKX",  selectedApiKey.secretKeyOKX, dataToSign, "BASE64");
                break;
                
            case 'openocean':
                apiUrl = "https://open-api.openocean.finance/v4/"+ DTChain.Kode_Chain +"/quote?inTokenAddress="+ sc_input +"&outTokenAddress="+ sc_output +"&amount="+ amount_in.toString()+"&gasPrice=" + Math.ceil(parseFloat(getFromLocalStorage('gasGWEI', 0)));

                break;

            case 'paraswap':
                apiUrl = "https://api.paraswap.io/prices?" + "srcToken=" + sc_input + "&srcDecimals=" + des_input + "&destToken=" + sc_output + "&destDecimals=" + des_output + "&side=SELL&network=" + DTChain.Kode_Chain + "&amount=" + amount_in + "&version=6.2";
                break;
            case 'jupiter':
                apiUrl = "https://quote-api.jup.ag/v6/quote?inputMint=" + sc_input_in + "&outputMint=" + sc_output_in + "&amount=" + amount_in;
                headers = {}; // Tidak memerlukan header khusus
                break;                 
            default:
                console.error("Unsupported DEX type");
                return;
        }
    
        $.ajax({
            url: apiUrl,
            method: ['odos','altodos'].includes(dexType) ? 'POST' : 'GET', // Cek tipe DEX
            headers: Object.assign(
                {}, 
                headers || {}, // Header tambahan dari variabel `headers`
                dexType === '0x' ? { '0x-api-key': "6f5d5c4d-bfdd-4fc7-8d3f-d3137094feb5" } : {},
                dexType === 'okx' ? {
                    "OK-ACCESS-PROJECT": selectedApiKey.ProjectOKX,
                    "OK-ACCESS-KEY": selectedApiKey.ApiKeyOKX,
                    "OK-ACCESS-SIGN": signature,
                    "OK-ACCESS-PASSPHRASE": selectedApiKey.PassphraseOKX,
                    "OK-ACCESS-TIMESTAMP": timestamp,
                } : {}
            ),
            data: ['odos','altodos' ].includes(dexType) ? JSON.stringify(requestData) : requestData, // Format data berdasarkan tipe DEX
            contentType: ['odos','altodos'].includes(dexType) ? 'application/json' : undefined, // Set `contentType` hanya jika diperlukan
          //  timeout: parseInt(SavedSettingData.waktuTunggu) * 1000, // Ambil waktu tunggu dari localStorage atau default ke 0
            success: function (response, xhr) {
                //console.log("RESPONSE DEX: ",response)
                var amount_out = null, FeeSwap = null; // Default kosong
                try {
                        switch (dexType) {
                            case 'kyberswap':
                                amount_out = response.data.routeSummary.amountOut / Math.pow(10, des_output);
                                FeeSwap = ((response.data.routeSummary.gas / Math.pow(10, 9)) * parseFloat(getFromLocalStorage('gasGWEI', 0))) * parseFloat(getFromLocalStorage('PRICEGAS', 0)); // Menggunakan getFromLocalStorage
                                break;
                            case 'kana':
                                const chainName = DTChain.Nama_Chain.toLowerCase();
                                const kanaChainId = KanaChainID[chainName];
                                if (!kanaChainId) {
                                    amount_out = response.priceRoute.destAmount / Math.pow(10, des_output);
                                    FeeSwap = parseFloat(response.priceRoute.gasCostUSD);
                                }else{
                                    amount_out = response.data[0].finalAmountOut / Math.pow(10, des_output);
                                    FeeSwap = (response.data[0].estimatedGas / Math.pow(10, 9)) * parseFloat(getFromLocalStorage('gasGWEI', 0)) * parseFloat(getFromLocalStorage('PRICEGAS', 0));                                    
                                }
                                break;
                            case 'odos':
                            if (action === "TokentoPair") {
                                    amount_out = response.outValues / PriceRate; 
                                } else if (action === "PairtoToken") {
                                    amount_out = parseFloat(response.outAmounts) / Math.pow(10, des_output);
                                }                               
                                FeeSwap = response.gasEstimateValue;
                                break;
                            case 'altodos':
                                if (action === "TokentoPair") {
                                    amount_out = parseFloat(response.odosResponse.outValues[0]) / PriceRate; 
                                } else if (action === "PairtoToken") {
                                    amount_out = parseFloat(response.odosResponse.outValues[0]) / Math.pow(10, des_output);
                                }                               
                                FeeSwap = response.odosResponse.gasEstimateValue;
                                break;
                            case 'paraswap':
                                amount_out = response.priceRoute.destAmount / Math.pow(10, des_output);
                                FeeSwap = parseFloat(response.priceRoute.gasCostUSD);
                                break;
                            case 'openocean':
                                amount_out = response.data.outAmount / Math.pow(10, des_output);
                                FeeSwap = parseFloat(response.data.estimatedGas);
                                break;
                            case '0x':
                                amount_out = response.buyAmount / Math.pow(10, des_output);
                                FeeSwap = ((response.transaction.gas / Math.pow(10, 9)) * parseFloat(getFromLocalStorage('PRICEGAS', 0))) ; // Menggunakan getFromLocalStorage
                                break;
                            case '1inch':
                                amount_out = parseFloat(response.dstAmount) / Math.pow(10, des_output);
                                FeeSwap = ((response.gas / Math.pow(10, 9) * parseFloat(getFromLocalStorage('gasGWEI', 0)))) * parseFloat(getFromLocalStorage('PRICEGAS', 0)); // Menggunakan getFromLocalStorage
                                break;
                            case 'magpie':
                                amount_out = parseFloat(response.amountOut) / Math.pow(10, des_output);
                                FeeSwap = parseFloat(response.fees[0].value);
                                break;    
                            case 'okx':
                                amount_out = response.data[0].toTokenAmount / Math.pow(10, des_output);
                                FeeSwap = (response.data[0].estimateGasFee / Math.pow(10, 9)) * parseFloat(getFromLocalStorage('gasGWEI', 0)) * parseFloat(getFromLocalStorage('PRICEGAS', 0));            
                                break;  
                            case 'jupiter':
                                var amount_out = response.outAmount/Math.pow(10, des_output);
                                FeeSwap = 0.1;                                
                            break;                                   
                            default:
                                throw new Error(`DEX type ${dexType} not supported.`);
                        }
                
                        const result = {
                            sc_input: sc_input,
                            des_input: des_input,
                            sc_output: sc_output,
                            des_output: des_output,
                            FeeSwap: FeeSwap,
                            amount_out: amount_out,
                            apiUrl: apiUrl,
                        };
                        callback(null, result);
                    } catch (error) {
                        callback({
                            statusCode: 500,
                            pesanDEX: `Error DEX : ${error.message}`,
                            color: "#f39999",
                            DEX: dexType.toUpperCase(),
                        }, null);
                    }
            },
            
            error: function (xhr) {
                var alertMessage = "Terjadi kesalahan";
                var warna = "#f39999";
                switch (xhr.status) {
                    case 0:  
//                        alertMessage = "NO RESPON"; 
                        if(dexType=='kyberswap' || dexType =='odos' ||  dexType == '0x'){
                            alertMessage = "KENA LIMIT";
                        }
                        // else if(dexType=='0x'){
                        //         getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, PriceRate, dexType, NameToken, NamePair, cex,action, callback);
                        //         console.log(`${dexType} PINDAH KE SWOOP`);
                        //     }
                            else{
                            alertMessage = "NULL RESPONSE";
                        }
                        /*
                        if(dexType=='kyberswap' || dexType=='odos'){
                            getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, PriceRate, dexType, NameToken, NamePair, cex,action, callback);
                            console.log(`${dexType} PINDAH KE SWOOP`);
                        }else{
                            alertMessage = "AKSES KENA LIMIT";
                        }
                        */
                        break;                        
                    case 400:
                        try { 
                            var errorResponse = JSON.parse(xhr.responseText);
                            if (
                                (errorResponse.description && errorResponse.description.toLowerCase().includes("insufficient liquidity")) || 
                                (errorResponse.error && errorResponse.error.toLowerCase().includes("no routes found with enough liquidity"))
                            ) {
                                alertMessage = "NO LP (No Liquidity Provider)";
                                warna = "#f39999";
                            } else {
                                alertMessage = errorResponse.detail || errorResponse.description || errorResponse.error || "KONEKSI BURUK";
                            }
                        } catch (e) {
                            alertMessage = "KONEKSI LAMBAT"; // Jika parsing gagal
                        }
                    break;
                    case 401:
                        alertMessage = "API SALAH";
                        break;
                    case 403:
                        alertMessage = "AKSES DIBLOK";
                        warna = "#fff";
                        // if(dexType=='0x'){
                        //         getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, PriceRate, dexType, NameToken, NamePair, cex,action, callback);
                        //         console.log(`${dexType} PINDAH KE SWOOP`);
                        //     }
                        break;
                    case 404:
                        alertMessage = "Permintaan tidak ditemukan";
                        break ;
                    case 429:
                            warna = "#f39999";
                            alertMessage = "AKSES KENA LIMIT";
                            /*
                            if(dexType=='okx'){
                                getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, PriceRate, dexType, NameToken, NamePair, cex,action, callback);
                                console.log(`${dexType} PINDAH KE SWOOP`);
                            }else{
                                alertMessage = "AKSES KENA LIMIT";
                            }
                            */
                        break;
                    case 500:
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            if (errorResponse.msg && errorResponse.msg.toLowerCase().includes("too many requests")) {
                                alertMessage = "AKSES KENA LIMIT (500 Too Many Requests)";
                                warna = "#f39999";
                            } else {
                                alertMessage = errorResponse.detail || "GAGAL DAPATKAN DATA";
                            }
                        } catch (e) {
                            alertMessage = "GAGAL DAPATKAN DATA";
                        }
                        break;
                    case 503:
                        alertMessage = "Layanan tidak tersedia";
                        break;
                    case 502:
                        alertMessage = "Respons tidak valid";
                        break;
                    default:
                        warna = "#f39999";
                        alertMessage = "Status: " + xhr.status;
                }
                $(`#SWAP_${dexId}`).html(`<a href="${linkDEX}" title="${dexType.toUpperCase()}: ${alertMessage}" target="_blank" class="uk-text-danger"><i class="bi bi-x-circle"></i> ${dexType.toUpperCase()} </a>`);

                callback({ 
                    statusCode: xhr.status, 
                    pesanDEX:`${dexType.toUpperCase()}: ${alertMessage}`,
                    color: warna, 
                    DEX: dexType.toUpperCase(),
                    dexURL: linkDEX 
                }, null);
            }, 
        });
    }
    
    // Fungsi untuk mengecek harga pada SWOOP
    function getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, PriceRate,  dexType, NameToken, NamePair, cex,action, callback) {
        // Mengambil data setting dari localStorage
        var SavedSettingData = getFromLocalStorage('DATA_SETTING', {});
        var dexId = `${cex}_${dexType.toUpperCase()}_${NameToken}_${NamePair}_${(DTChain.Nama_Chain).toUpperCase()}`;
       // var amount_in = Math.pow(10, des_input) * amount_in;
        var amount_in = BigInt(Math.round(Number(amount_in)));

        var dexURL = generateDexLink(dexType, NameToken, sc_input, NamePair, sc_output);
        
        var payload = {
            "chainId": DTChain.Kode_Chain,
            "aggregatorSlug": dexType.toLowerCase(),
            "sender": SavedSettingData.walletMeta,
            "inToken": {
                "chainId": DTChain.Kode_Chain,
                "type": "TOKEN",
                "address": sc_input.toLowerCase(),
                "decimals": parseFloat(des_input)
            },
            "outToken": {
                "chainId": DTChain.Kode_Chain,
                "type": "TOKEN",
                "address": sc_output.toLowerCase(),
                "decimals": parseFloat(des_output)
            },
            "amountInWei": String(amount_in),
            "slippageBps": "100",
            "gasPriceGwei": Number(getFromLocalStorage('gasGWEI', 0)),
        };
    
        $.ajax({
            url:'https://bzvwrjfhuefn.up.railway.app/swap',

           // url:'https://swoop-backend.up.railway.app/swap',
           // url:'https://swoop-backend-2.up.railway.app/swap',

            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (response) {
                    var amount_out = parseFloat(response.amountOutWei) / Math.pow(10, des_output);
                    var FeeSwap = ((parseFloat(getFromLocalStorage('gasGWEI')) * 250000) / Math.pow(10, 9))*parseFloat(getFromLocalStorage('PRICEGAS'));
                    const result = {
                            sc_input: sc_input,
                            des_input: des_input,
                            sc_output: sc_output,
                            des_output: des_output,
                            FeeSwap: FeeSwap,
                            dex: dexType,
                            amount_out: amount_out,
                        };
                        callback(null, result);
                    },
            error: function (xhr) {
                var alertMessage = "Terjadi kesalahan";
                var warna = "#f39999";
            
                switch (xhr.status) {
                    case 0:
                        alertMessage = "NO RESPONSE";
                        break;
                    case 400:
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            alertMessage = errorResponse.detail || errorResponse.description || "KONEKSI BURUK";
                        } catch (e) {
                            alertMessage = "KONEKSI LAMBAT"; // Jika parsing gagal
                        }
                        break;
                    case 403:
                        alertMessage = "AKSES DIBLOK";
                        break;
                    case 404:
                        alertMessage = "Permintaan tidak ditemukan";
                        break;
                    case 429:
                       alertMessage = "AKSES KENA LIMIT";
                        break;
                    case 500:
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            alertMessage = errorResponse.message || "GAGAL DAPATKAN DATA";
                        } catch (e) {
                            alertMessage = "GAGAL DAPATKAN DATA"; // Jika parsing gagal
                        }
                        break;
                    case 503:
                        alertMessage = "Layanan tidak tersedia";
                        break;
                    case 502:
                        alertMessage = "Respons tidak valid";
                        break;
                    default:
                        warna = "#f39999";
                        alertMessage = "Status: " + xhr.status;
                }

//                $(`#SWAP_${dexId}`).html(`<a href="${dexURL}" title="${dexType.toUpperCase()}: ${alertMessage}" target="_blank" class="uk-text-danger"><i class="bi bi-x-circle"></i> ${dexType.toUpperCase()} </a>`);

                // Kirim callback untuk penanganan lebih lanjut
                callback({ 
                    statusCode: xhr.status, 
                    pesanDEX: "SWOOP: "+alertMessage, 
                    color: warna, 
                    DEX: dexType.toUpperCase(), 
                    dexURL: dexURL 
                }, null);
            }
            
        });
    }

    // Fungsi untuk mengecek harga pada RANGO
    function getPriceRANGO(sc_input, des_input, sc_output, des_output, amount_in, PriceRate,dexType, NameToken,  NamePair, cex, callback) {
        var dexId = `${cex}_${dexType.toUpperCase()}_${NameToken}_${NamePair}_${(DTChain.Nama_Chain).toUpperCase()}`;
      //  var amount_in = Number(amount_in) / Math.pow(10, 18);

        let transformedChain = 
            DTChain.Nama_Chain.toUpperCase() === "ETHEREUM" ? "ETH" : 
            DTChain.Nama_Chain.toUpperCase() === "AVAX" ? "AVAX_CCHAIN" : 
            DTChain.Nama_Chain.toUpperCase();
            
        var dexLinks = generateDexLink(dexType, NameToken, sc_input, NamePair, sc_output);

        const NetworkChain = (DTChain.Nama_Chain || "").toUpperCase() === "ETHEREUM"
            ? "ETH"
            : (DTChain.Nama_Chain || "").toUpperCase() === "AVAX"
                ? "AVAX_CCHAIN"
                : DTChain.Nama_Chain.toUpperCase();

        const swappersMap = {
          //  kyberswap: ["KyberSwapV3"],
          //  kana: ["kana"],
            odos: ["Odos"],
         //   okx: ["Okc Swap"],
         //   "1inch": ["1Inch"],
        };
        const swapperGroups = swappersMap[dexType] || [];
        const apiKeysRango = [
           // "a24ca428-a18e-4e84-b57f-edb3e2a5bf13", // rubic
            "c6381a79-2817-4602-83bf-6a641a409e32", // umum
            "4a624ab5-16ff-4f96-90b7-ab00ddfc342c" //baru
        ];

        // Fungsi untuk mendapatkan API Key secara acak
        function getRandomApiKeyRango() {
            const randomIndex = Math.floor(Math.random() * apiKeysRango.length);
            return apiKeysRango[randomIndex];
        }

        // Variabel untuk API Key
        const apiRango = getRandomApiKeyRango();
        const apiUrl = `https://api.rango.exchange/routing/bests?apiKey=${apiRango}`;

        const requestData = {
            from: {
                blockchain: NetworkChain,
                symbol: NameToken.toUpperCase(),
                address: sc_input,
            },
            to: {
                blockchain: NetworkChain,
                symbol: NamePair.toUpperCase(),
                address: sc_output,
            },
            amount: amount_in.toString(),
            swappersExclude: false,
            swapperGroups: swapperGroups,
        };

        $.ajax({
            url: apiUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function (response, xhr) {
                if (response.results && Array.isArray(response.results) && response.results.length > 0) {
                const firstResult = response.results[0];
                const amount_out = parseFloat(firstResult.outputAmount); // Jumlah output
                let FeeSwap = 0;
            
                // Proses fee jika data swap tersedia
                if (firstResult.swaps && firstResult.swaps.length > 0) {
                    const swap = firstResult.swaps[0]; // Ambil swap pertama
                    swapperId = swap.swapperId;        // Ambil swapperId
                    toAmount = parseFloat(swap.toAmount); // Ambil toAmount
            
                    const feeArray = swap.fee; // Array fee
                    // Cari Network Fee
                    const networkFee = feeArray.find(fee => fee.name === "Network Fee");
                    if (networkFee) {
                        FeeSwap = parseFloat(networkFee.amount) * parseFloat(networkFee.price); // Hitung Fee Swap
                    }
                }              

                const result = {
                    sc_input:sc_input,
                    des_input:des_input,
                    sc_output:sc_output,
                    des_output:des_output,
                    FeeSwap: FeeSwap,
                    amount_out: amount_out,
                };
                callback(null, result);
            }

            },                
            
            error: function (xhr) {
                let alertMessage = "Kesalahan tidak diketahui";
                let warna = "#f39999";
            
                // Jika ada responseJSON dan memiliki key description, gunakan pesan ini
                if (xhr.responseJSON && xhr.responseJSON.description) {
                    alertMessage = xhr.responseJSON.description;
                } else {
                    // Fallback ke switch berdasarkan status HTTP jika tidak ada description
                    switch (xhr.status) {
                        case 0: 
                            alertMessage = "SERING SCAN"; 
                            break;
                        case 400: 
                            alertMessage = "KONEKSI BURUK"; 
                            break;
                        case 403: 
                            alertMessage = "AKSES DIBLOK"; 
                            break;
                        case 404: 
                            alertMessage = "Permintaan tidak ditemukan"; 
                            break;
                        case 429:
                            alertMessage = "KENA LIMIT";
                            break;
                        case 500: 
                            alertMessage = xhr.responseJSONmessage || "GAGAL DAPATKAN DATA"; 
                            break;
                        case 503: 
                            alertMessage = "Layanan tidak tersedia"; 
                            break;
                        default: 
                           warna = "#f39999";
                            alertMessage = `Status: ${xhr.status}`;
                    }
                }

                // Kirim callback untuk menangani error lebih lanjut
                callback({ 
                    statusCode: xhr.status, 
                    pesanDEX: "RANGO: "+alertMessage, 
                    color: warna, 
                    DEX: dexType.toUpperCase() 
                }, null);
            }
            
        });        
    }
    // ALL Sent TELE
    function sendStatusTELE(user, status) {
        var users = [
            { chat_id: SavedSettingData.ID_GRUP }
        ];

        var token = SavedSettingData.TOKEN;
        var apiUrl = 'https://api.telegram.org/bot' + token + '/sendMessage';

        // Ambil data dari localStorage dan parse sebagai JSON object
        var data = getFromLocalStorage('ID','');
        var pilihDex = getFromLocalStorage('DEX_PILIH', null);
        var pilihCex = getFromLocalStorage('CEX_PILIH', null);
        var dexList = pilihDex ? pilihDex.join(', ') : 'Not Selected';
        var cexList = pilihCex ? pilihCex.join(', ') : 'Not Selected';

        var message = " #" + user.toUpperCase() + " is <b>[ " + status + " ]</b>" +
            "\n ----------------------------------------------------"+
            "\n <b> MULTIPAIR_V3 ~ "+DTChain.Nama_Chain.toUpperCase()+" </b>"+
            "\n <b> CEX: </b>" + cexList.toUpperCase() +
            "\n <b> DEX: </b>" + dexList.toUpperCase() +
            "\n <b> ID UNIX : </b>" + data.id +
            "\n <b> PROVIDER : </b> " + data.name +
            "\n <b> IP : </b>" + data.ip+
            "\n ----------------------------------------------------";
        // Loop melalui daftar pengguna
        for (var i = 0; i < users.length; i++) {
            var user = users[i];
            var chatId = user.chat_id; // Ganti dengan ID chat pengguna

            // Membuat permintaan POST menggunakan jQuery
            $.ajax({
            url: apiUrl,
            method: "POST",
            data: {
                chat_id: chatId,
                text: message,
                parse_mode: "HTML",
                disable_web_page_preview: true
            },
            success: function(response) {
                // console.log("Message sent successfully");
            },
            error: function(xhr, status, error) {
                console.log("Error sending message:", error);
            }
            });
          }
        }
        //sent sinyal kegrup tele
        function MultisendMessage(cex, dex, token,pair, modal, PNL, priceBUY, priceSELL, FeeSwap,FeeWD, totalFee,nickname,sc_in,sc_out) {
            // Mengambil user dari localStorage menggunakan getFromLocalStorage  
            let Linksctoken=`<a href="${DTChain.URL_Chain}/token/${sc_in}" target="_blank" class="uk-link"> ${token}</a>`;
            let Linkscpair=`<a href="${DTChain.URL_Chain}/token/${sc_out}" target="_blank" class="uk-link">  ${pair}</a>`;
            var message = 
                "<b>#MULTIPAIR_V3 #" + DTChain.Nama_Chain.toUpperCase() + "\n USER : </b> ~ " + nickname +
                " \n ----------------------------------------- \n MARKET: " + cex +" VS " + dex +
                " \n TOKEN-PAIR: <b>#" + token+"_"+pair + "</b> " + 
                " \n MODAL: <b> " + modal + "$</b> | PROFIT: <b>" + PNL.toFixed(2) + "$ </b> " +
                " \n <b>BUY "+Linksctoken+": </b> " + priceBUY.toFixed(9) +
                " \n <b>SELL "+Linkscpair+": </b>" + priceSELL.toFixed(9) + 
                " \n <b>FEEWD: </b>" + FeeWD.toFixed(3) + 
                " \n FEETOTAL: <b>" + totalFee.toFixed(2) + "$</b> | SWAP:<b>" + FeeSwap.toFixed(2) + "$</b>" +
                " \n -----------------------------------------";
        
            // Mengambil setting dari localStorage
            var SavedSettingData = getFromLocalStorage('DATA_SETTING', { ID_GRUP: 0, TOKEN: '' });
            var users = [
                { chat_id: SavedSettingData.ID_GRUP } // Menggunakan ID grup yang disimpan di localStorage
            ];
        
            var token = SavedSettingData.TOKEN; // Menggunakan token yang disimpan di localStorage
            var apiUrl = 'https://api.telegram.org/bot' + token + '/sendMessage';
        
            // Loop melalui daftar pengguna dan mengirim pesan
            for (var i = 0; i < users.length; i++) {
                var user = users[i];
                var chatId = user.chat_id; // ID chat pengguna
        
                // Membuat permintaan POST menggunakan jQuery
                $.ajax({
                    url: apiUrl,
                    method: "POST",
                    data: {
                        chat_id: chatId,
                        text: message,
                        parse_mode: "HTML",
                        disable_web_page_preview: true
                    },
                    success: function (response) {
                        // console.log("Message sent successfully");
                    },
                    error: function (xhr, status, error) {
                        // console.log("Error sending message:", error);
                    }
                });
            }
        }
    // Fungsi CekIdentitas untuk mendapatkan ID perangkat
    async function CekIdentitas() {
        try {
            let deviceID = generateDeviceID();
            let response = await fetch('https://api4.my-ip.io/v2/ip.json');
            let data = await response.json();

            let simplifiedIdentitas = {
                id: deviceID,
                name: data.asn.name,
                ip: data.ip
            };

            saveToLocalStorage('ID', simplifiedIdentitas);
            let savedID = getFromLocalStorage('ID', {});
        } catch (error) {
            //toastr.info("GAGAL CEK IP!!");
        }
    }

    // Fungsi generateDeviceID
    function generateDeviceID() {
        let userAgent = navigator.userAgent;
        let screenResolution = `${window.screen.width}x${window.screen.height}`;
        let timezoneOffset = new Date().getTimezoneOffset();
        let language = navigator.language;

        return hashCode(`${userAgent}${screenResolution}${timezoneOffset}${language}`);
    }

    // Fungsi untuk menghasilkan hashCode
    function hashCode(str) {
        return str.split("").reduce((hash, char) => {
            hash = ((hash << 5) - hash) + char.charCodeAt(0);
            return hash & hash;
        }, 0);
    }

    $('#UpdateWalletCEX').on('click', function () {
        // Ambil daftar CEX yang dipilih dari localStorage
        const selectedCEX = getFromLocalStorage("selectedCEX", []); // Ambil data terpilih, default array kosong jika tidak ada
        if (selectedCEX.length === 0) {
            toastr.error("Tidak ada CEX yang dipilih. Silakan pilih CEX terlebih dahulu.");
            return;
        }

        console.log("CEX yang dipilih:");
        selectedCEX.forEach(exchange => {
            console.log(`- ${exchange}`);
        });

        allFeeWD = [];
        isGateSuccess = false;
        isBinanceSuccess = false;
        isKucoinSuccess = false;
        isBitgetSuccess = false;
        isBybitSuccess = false;
        isMexcSuccess = false;
        isOkxSuccess = false;

        // Cek dan panggil fungsi cek fee withdrawal hanya untuk CEX yang dipilih
        selectedCEX.forEach(exchange => {
            if (CONFIG_CEX[exchange]) {
                console.log(`Memeriksa Status Wallet ${exchange.toUpperCase()}...`);
                switch (exchange) {
                    case "GATE":
                        CekfeeWDGATE(CONFIG_CEX.GATE);
                        break;
                    case "BINANCE":
                        CekfeeWDBINANCE(CONFIG_CEX.BINANCE);
                        break;
                    case "KUCOIN":
                        CekfeeWDKUCOIN(CONFIG_CEX.KUCOIN);
                        break;
                    case "BYBIT":
                        CekfeeWDBYBIT(CONFIG_CEX.BYBIT);
                        break;
                    case "BITGET":
                        CekfeeWDBITGET(CONFIG_CEX.BITGET);
                        break;
                    case "MEXC":
                        CekfeeWDMEXC(CONFIG_CEX.MEXC);
                        break;
                    case "OKX":
                        CekfeeWDOKX(CONFIG_CEX.OKX);
                        break;
                    default:
                        console.warn(`CEX ${exchange} tidak dikenali.`);
                }
            }
        });
    });

    // Fungsi untuk mengecek apakah semua pembaruan berhasil
    function checkAllUpdatesCompleted() {
        // Pengecekan manual dengan menggunakan if
        let allSuccess = true;
        let isSuccess=0;

        if (CONFIG_CEX.GATE && isGateSuccess !== true) {
            allSuccess = false;
        }else{
            isSuccess++;
        }

        if (CONFIG_CEX.BINANCE && isBinanceSuccess !== true) {
            allSuccess = false;
        }else{
            isSuccess++;
        }

        if (CONFIG_CEX.KUCOIN && isKucoinSuccess !== true) {
            allSuccess = false;
        }else{
            isSuccess++;
        }

        if (CONFIG_CEX.BYBIT && isBybitSuccess !== true) {
            allSuccess = false;
        }else{
            isSuccess++;
        }

        if (CONFIG_CEX.BITGET && isBitgetSuccess !== true) {
            allSuccess = false;
        }else{
            isSuccess++;
        }

        if (CONFIG_CEX.MEXC && isMexcSuccess !== true) {
            allSuccess = false;
        }else{
            isSuccess++;
        }

        if (CONFIG_CEX.OKX && isOkxSuccess !== true) {
            allSuccess = false;
        }else{
            isSuccess++;
        }

            const selectedCEX = getFromLocalStorage("selectedCEX", []);  
            const lastModifiedTime = new Date().toLocaleString(); // Waktu terakhir update
            const totalWallets = allFeeWD.length; // Hitung jumlah wallet yang diperbarui
            
            if (allFeeWD.length >= 0 && isSuccess==selectedCEX.length) {
                removeFromLocalStorage("WALLET_CEX");
                removeFromLocalStorage("LASTUPDATE_FEEWD");

                saveToLocalStorage("WALLET_CEX", allFeeWD); // Simpan ke localStorage
                saveToLocalStorage("LASTUPDATE_FEEWD",lastModifiedTime);
                // Ambil data dari localStorage dengan key "TOKEN_SCANNER"
                const storedData = getFromLocalStorage("TOKEN_SCANNER", []); // Ambil data token yang sudah ada
                const WalletCEXData = getFromLocalStorage("WALLET_CEX", []); // Ambil data Wallet CEX dari localStorage

                // Gabungkan data dari TOKEN dan status dari WALLET_CEX
                const combinedData = storedData.map(token => {
                    // Cari data wallet CEX berdasarkan CEX dan tokenName yang sesuai untuk withdraw (symbol_in)
                    const walletToken = WalletCEXData.find(item =>
                        item.cex === token.cex && item.tokenName === token.symbol_in
                    );

                    // Cari data wallet CEX berdasarkan CEX dan tokenName yang sesuai untuk deposit (symbol_out)
                    const walletPair = WalletCEXData.find(item =>
                        item.cex === token.cex && item.tokenName === token.symbol_out
                    );

                    // Gabungkan data token dengan status wallet
                    return {
                        ...token,  // Gabungkan data token yang sudah ada
                        feeWDToken: walletToken ? walletToken.feeWDs : "",
                        feeWDPair: walletPair ? walletPair.feeWDs : "",  // Fee Withdraw diambil dari symbol_in
                        depositPair: walletPair ? walletPair.depositEnable : false,  // Status Deposit
                        withdrawToken: walletToken ? walletToken.withdrawEnable : false,  // Status Withdraw
                        depositToken: walletToken ? walletToken.depositEnable : false,  // Status Deposit
                        withdrawPair: walletPair ? walletPair.withdrawEnable : false  // Status Withdraw

                    };
                });

                // Konfirmasi dari pengguna
                if (confirm('RELOAD STATUS WITHDRAW & DEPOSIT CEX?')) {
                    saveToLocalStorage("TOKEN_SCANNER", combinedData);

                    const savedData = getFromLocalStorage("TOKEN_SCANNER", []);

                    // Validasi apakah data berhasil disimpan
                    if (savedData.length === combinedData.length) {
                        alert("✅ SUKSES UPDATE WALLET CEX");
                        setLastAction("UPDATE WALLET CEX");
                        location.reload();
                    } else {
                        toastr.error("GAGAL MEMPERBAHARUI DATA WALLET CEX! ❌", {
                            timeOut: 5000,
                            progressBar: true,
                            closeButton: true,
                        });
                        setLastAction("GAGAL UPDATE WALLET");
                    }
                }
        }
    }
   
    // Fungsi untuk Signature CEX
    function calculateSignature(exchange, apiSecret, dataToSign, hashMethod = "HmacSHA256") {
        if (!apiSecret || !dataToSign) {
            console.error(`[${exchange}] API Secret atau Data untuk Signature tidak valid!`);
            return null;
        }
    
        switch (exchange.toUpperCase()) {
            case "MEXC":
            case "BINANCE":
            case "KUCOIN":
            case "BYBIT":
                // Gunakan HMAC-SHA256
                return CryptoJS[hashMethod](dataToSign, apiSecret).toString(CryptoJS.enc.Hex);
    
            case "OKX":
                // Gunakan BASE64 untuk OKX
                const hmac = CryptoJS.HmacSHA256(dataToSign, apiSecret);
                return CryptoJS.enc.Base64.stringify(hmac);
    
            default:
                console.error(`[${exchange}] Exchange tidak didukung untuk perhitungan signature.`);
                return null;
        }
    }    

    //fungsi cek FEE WD per TOKEN GATE
    function CekfeeWDGATE() {
            var key = CONFIG_CEX.GATE.ApiKey;
            var secret = CONFIG_CEX.GATE.ApiSecret;
            var host = "https://cors-anywhere.herokuapp.com/https://api.gateio.ws";
            var prefix = "/api/v4";
            var method = "GET";
            var chain = DTChain.CEXCHAIN.GATE.chainCEX; // Chain yang difokuskan
            var timestamp = Math.floor(Date.now() / 1000); // Current timestamp in seconds

            var buildSignature = function (url, body) {
                var bodyHash = CryptoJS.SHA512(body).toString(CryptoJS.enc.Hex);
                var signString = method + "\n" + prefix + url + "\n" + "" + "\n" + bodyHash + "\n" + timestamp;
                var hmac = CryptoJS.HmacSHA512(signString, secret);
                return hmac.toString(CryptoJS.enc.Hex);
            };

            // API untuk fee WD
            var feeWDUrl = "/wallet/withdraw_status";
            var feeWDHeaders = {
                'Timestamp': timestamp,
                'KEY': key,
                'SIGN': buildSignature(feeWDUrl, "")
            };

            // API untuk status deposit dan withdraw
            var statusUrl = "/spot/currencies";
            var statusHeaders = {
                'Timestamp': timestamp,
                'KEY': key,
                'SIGN': buildSignature(statusUrl, "")
            };

            // Lakukan dua panggilan API secara paralel
            $.when(
                $.ajax({
                    url: host + prefix + feeWDUrl,
                    method: method,
                    headers: feeWDHeaders
                }),
                $.ajax({
                    url: host + prefix + statusUrl,
                    method: method,
                    headers: statusHeaders
                })
            ).done(function (feeWDResponse, statusResponse) {
                var feeWDData = feeWDResponse[0];
                var statusData = statusResponse[0];

                if (!Array.isArray(feeWDData) || !Array.isArray(statusData)) {
                    console.error("Unexpected API response");
                    toastr.error("Respons API tidak sesuai format!");
                    return;
                }

                // Gabungkan data status dan fee WD
                var combinedData = statusData
                    .filter(function (statusItem) {
                        // Filter status berdasarkan chain yang relevan
                        return (
                            statusItem.currency &&
                            !statusItem.currency.includes("_OLD") &&
                            !statusItem.delisted &&
                            statusItem.chain === chain
                        );
                    })
                    .map(function (statusItem) {
                        var feeWDItem = feeWDData.find(function (feeItem) {
                            var statusCurrency = statusItem.currency;
                            var feeCurrency = feeItem.currency;

                            // Hapus suffix "_chain" pada statusItem.currency jika ada
                            var cleanStatusCurrency = statusCurrency.replace(`-${chain}`, "");

                            // Bandingkan currency tanpa suffix "_chain" dengan feeCurrency
                            if (feeCurrency === cleanStatusCurrency) {
                                return feeItem.withdraw_fix_on_chains && feeItem.withdraw_fix_on_chains[chain];
                            }

                            return false;
                        });

                        // Jika feeWDItem tidak ditemukan, set feeWDs ke null atau nilai default lain
                        var feeWD = feeWDItem ? parseFloat(feeWDItem.withdraw_fix_on_chains[chain]) : null;

                        return {
                            cex: "GATE",
                            chain: statusItem.chain || "---",
                            tokenName: statusItem.currency.replace(`-${chain}`, "") || "---", // Hapus suffix "_chain"
                            scToken: "---", // Tetap default
                            depositEnable: !statusItem.deposit_disabled ? true : false,
                            withdrawEnable: !statusItem.withdraw_disabled ? true : false,
                            feeWDs: feeWD // Tetap simpan dengan feeWD yang ada atau null jika tidak ditemukan
                        };
                    });

                // Tampilkan data gabungan sebelum filter final
                //console.log("Data Gabungan Sebelum Filter Final:", combinedData);

                // Filter hasil berdasarkan ketersediaan feeWDs dan tokenName yang valid
                combinedData = combinedData.filter(function (item) {
                    return item.chain && item.tokenName;
                });

                console.log("GATE WALLET:",combinedData);
                // Gabungkan hasil ke allFeeWD
                allFeeWD = allFeeWD.concat(combinedData);
                //checkAndSaveAllFeeWD();
                isGateSuccess = true; // Tandai sukses
                toastr.info("SUKSES, CEK UPDATE WALLET GATE");
                checkAllUpdatesCompleted();

            }).fail(function (xhr, status, error) {
                console.error("Error:", error);
                toastr.error("Gagal mendapatkan data dari API GATE");
            });
        }
    //fungsi cek FEE WD per TOKEN BITGET
    function CekfeeWDBITGET() {
        $.ajax({
            url: 'https://api.bitget.com/api/v2/spot/public/coins',
            method: "GET",
           
                success: function(response) {

                // Filter data untuk coin dengan network sesuai dengan chainTypeConfig dan hanya yang deposit atau withdraw aktif
                const coinsWithChain = response.data.filter(function(item) {
                    return item.chains.some(function(chain) {
                        // If chain is 'erc20' and coin is 'ETH', treat it as 'eth'
                        if (DTChain.CEXCHAIN.BITGET.chainCEX === 'ERC20' && item.coin === 'ETH') {
                            chain.chain = 'ETH';
                        }
                        return (chain.chain === DTChain.CEXCHAIN.BITGET.chainCEX || chain.chain === 'ETH') &&
                            (chain.rechargeable === "true" || chain.withdrawable === "true"); // Salah satu harus aktif
                    });
                });

                const coinDepositWithdrawStatus = coinsWithChain.map(function(item) {
                    const CEXChain = item.chains.find(function(chain) {
                        return chain.chain === DTChain.CEXCHAIN.BITGET.chainCEX || chain.chain === 'ETH';
                    });

                    return {
                        cex: "BITGET",
                        chain: CEXChain ? CEXChain.chain : '---',  // If chain is found, return it, else '---'
                        tokenName: item.coin,
                        scToken: CEXChain ? CEXChain.contractAddress : "---",  // If no contractAddress, display "---"
                        feeWDs: CEXChain ? CEXChain.withdrawFee : 0,
                        depositEnable: CEXChain ? CEXChain.rechargeable === "true" : false,
                        withdrawEnable: CEXChain ? CEXChain.withdrawable === "true" : false
                    };
                });

                console.log("BITGET WALLET:", coinDepositWithdrawStatus);
                
                // Gabungkan hasil ke allFeeWD
                allFeeWD = allFeeWD.concat(coinDepositWithdrawStatus);
                
                //checkAndSaveAllFeeWD();
                isBitgetSuccess = true; // Tandai sukses
                toastr.info("SUKSES, CEK UPDATE WALLET BITGET");
                checkAllUpdatesCompleted();

            },
            error: function(xhr, status, error) {
                toastr.error('UPDATE FEE WD BITGET GAGAL, SILAKAN REFRESH!!');
            }
        });
    }   //fungsi cek FEE WD per TOKEN KUCOIN
    function CekfeeWDKUCOIN() {
        const ApiKey = CONFIG_CEX.KUCOIN.ApiKey;
        const ApiSecret = CONFIG_CEX.KUCOIN.ApiSecret;
        const ApiPassphrase = CONFIG_CEX.KUCOIN.ApiPassphrase;
    
        // Timestamp dan endpoint
        const timestamp = Date.now().toString();
        const endpoint = "/api/v3/currencies";
        const queryString = ""; // KuCoin tidak memerlukan query string tambahan dalam request ini
        
        // Format data untuk dihitung signature
        const dataToSign = timestamp + "GET" + endpoint + queryString;
        const signature = calculateSignature("KUCOIN", ApiSecret, dataToSign, "HmacSHA256");
        const passphraseSignature = calculateSignature("KUCOIN", ApiSecret, ApiPassphrase, "HmacSHA256");
    
        if (!signature || !passphraseSignature) {
            toastr.error("Gagal menghitung signature KuCoin. Periksa konfigurasi.");
            return;
        }
    
        const apiUrl = selectedServer+"https://api.kucoin.com" + endpoint;
//        const apiUrl = "https://api.kucoin.com" + endpoint;
    
        $.ajax({
            url: `${apiUrl}?${queryString}&signature=${signature}`,
            method: "GET",
            headers: {
                "KC-API-KEY": ApiKey,
                "KC-API-TIMESTAMP": timestamp,
                "KC-API-SIGN": signature,
                "KC-API-PASSPHRASE": CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA256(ApiPassphrase, ApiSecret)),
                "KC-API-KEY-VERSION": "2",
            },
            success: function (data) {
                if (data.code === "200000") { // Pastikan kode respon sukses

                    // Filter berdasarkan chainName yang sesuai dan status deposit & withdraw aktif
                    const filteredCoins = data.data.filter(function (item) {
                        return item.chains && item.chains.some(function (network) {
                            return network.chainName === DTChain.CEXCHAIN.KUCOIN.chainCEX && // Filter berdasarkan chain yang diinginkan
                                (network.isDepositEnabled === true || network.isWithdrawEnabled === true); // Pastikan salah satu status aktif
                        });
                    });

                    // Ambil hanya koin beserta status deposit dan withdraw untuk jaringan yang sesuai
                    const coinDepositWithdrawStatus = filteredCoins.map(function (item) {
                        const network = item.chains.find(function (network) {
                            return network.chainName === DTChain.CEXCHAIN.KUCOIN.chainCEX;
                        });

                        return {
                            cex: "KUCOIN",
                            chain: DTChain.CEXCHAIN.KUCOIN.chainCEX,
                            tokenName: item.currency,
                            scToken: network ? network.contractAddress : "---", // Jika tidak ada contractAddress, tampilkan "---"
                            feeWDs: network ? network.withdrawalMinFee : 0,
                            depositEnable: network ? network.isDepositEnabled : false,
                            withdrawEnable: network ? network.isWithdrawEnabled : false
                        };
                    });

                    // Gabungkan hasil ke allFeeWD
                    console.log("KUCOIN WALLET:",coinDepositWithdrawStatus);
                    allFeeWD = allFeeWD.concat(coinDepositWithdrawStatus);
                    //checkAndSaveAllFeeWD();

                    isKucoinSuccess = true; // Tandai sukses
                    toastr.info("SUKSES, CEK UPDATE WALLET KUCOIN");
                    checkAllUpdatesCompleted();
                } else {
                    toastr.error('Gagal mendapatkan data, kode: ' + data.code);
                }
            },
            error: function (xhr, status, error) {
                toastr.error('UPDATE FEE WD KUCOIN GAGAL, SILAKAN REFRESH!!');
            }
        });
    }
    // Fungsi cek FEE WD per TOKEN BINANCE    
    function CekfeeWDBINANCE() {
        const ApiKey = CONFIG_CEX.BINANCE.ApiKey;
        const ApiSecret = CONFIG_CEX.BINANCE.ApiSecret;
    
        const timestamp = Date.now().toString();
        const recvWindow = CONFIG_CEX.BINANCE.recvWindow || "5000";
        const queryString = `timestamp=${timestamp}`;
        const signature = calculateSignature("BINANCE", ApiSecret, queryString, "HmacSHA256");
    
        if (!signature) {
            toastr.error("Gagal menghitung signature Binance. Periksa konfigurasi.");
            return;
        }
    
        const apiUrl = "https://api.binance.me/sapi/v1/capital/config/getall";
    
        $.ajax({
            url: `${apiUrl}?timestamp=${timestamp}&signature=${signature}`,
            method: "GET",
            headers: {
                "X-MBX-ApiKey": ApiKey,
            },
            success: function (data) {
                // Filter berdasarkan network yang sesuai dengan DTChain.CEXCHAIN.BINANCE.chainCEX dan status trading yang true
                const coinsWithNetworkAndTradingTrue = data.filter(function (item) {
                    return item.trading === true && item.networkList.some(function (network) {
                        return network.network === DTChain.CEXCHAIN.BINANCE.chainCEX;
                    });
                });
    
                // Ambil hanya koin beserta status deposit dan withdraw untuk jaringan yang sesuai
                const coinDepositWithdrawStatus = coinsWithNetworkAndTradingTrue.map(function (item) {
                    const Network = item.networkList.find(function (network) {
                        return network.network === DTChain.CEXCHAIN.BINANCE.chainCEX;
                    });
    
                    // Memastikan depositEnable atau withdrawEnable adalah true
                    const depositEnable = Network ? Network.depositEnable === true : false;
                    const withdrawEnable = Network ? Network.withdrawEnable === true : false;
    
                    // Hanya ambil token yang salah satunya memiliki status true
                    if (depositEnable || withdrawEnable) {
                        return {
                            cex: "BINANCE",
                            chain: DTChain.CEXCHAIN.BINANCE.chainCEX,
                            tokenName: item.coin,
                            scToken: Network.contractAddress,
                            feeWDs: Network ? Network.withdrawFee : 0,
                            depositEnable: depositEnable,
                            withdrawEnable: withdrawEnable
                        };
                    }
                    return null; // Token ini diabaikan jika kedua status adalah false
                }).filter(item => item !== null); // Hapus nilai null (yang tidak memenuhi syarat)                
               
                console.log("BINANCE WALLET:",coinDepositWithdrawStatus);
                // Gabungkan hasil ke allFeeWD
                allFeeWD = allFeeWD.concat(coinDepositWithdrawStatus);
                //checkAndSaveAllFeeWD();
    
                toastr.info("SUKSES, CEK UPDATE WALLET BINANCE");
    
                isBinanceSuccess = true; // Tandai sukses
                checkAllUpdatesCompleted();
            },
            error: function () {
                toastr.error('UPDATE FEE WD BINANCE GAGAL, SILAKAN REFRESH!!');
            }
        });
    }    
    // fungsi mengecek status DEPO & WD MEXC
    function CekfeeWDMEXC() {
        const ApiKey = CONFIG_CEX.MEXC.ApiKey; // Ambil API Key dari konfigurasi
        const chainTypeConfig = DTChain.CEXCHAIN.MEXC.chainCEX; // Ambil nilai chainType dari konfigurasi
        const apiSecret = CONFIG_CEX.MEXC.ApiSecret;
        const timestamp = Date.now().toString();
        const recvWindow = "5000";
        const queryString = `recvWindow=${recvWindow}&timestamp=${timestamp}`;
        const signature = calculateSignature("MEXC", apiSecret, queryString);
        if (!signature) {
            toastr.error("Gagal menghitung signature MEXC. Periksa konfigurasi.");
            return;
        }

        const apiUrl = `https://cors-anywhere.herokuapp.com/https://api.mexc.com/api/v3/capital/config/getall`;
        
        $.ajax({
            url: `${apiUrl}?${queryString}&signature=${signature}`,
            method: "GET",
            headers: {
                "X-MEXC-APIKEY": ApiKey,
            },
            success: function (data) {
                // Filter koin berdasarkan konfigurasi chainType
                const coinsWithNetwork = data.filter(item => 
                    item.networkList.some(network => network.netWork === chainTypeConfig)
                );
    
                // Mapping koin yang ditemukan untuk mendapatkan informasi fee dan sc
                const coinDepositWithdrawStatus = coinsWithNetwork.map(item => {
                    const selectedNetwork = item.networkList.find(network => network.netWork === chainTypeConfig);
    
                    return {
                        cex: "MEXC",
                        chain: DTChain.CEXCHAIN.MEXC.chainCEX,
                        tokenName: item.coin,
                        scToken: selectedNetwork ? selectedNetwork.contract : "---",  // Ambil contract address jika ada
                        feeWDs: selectedNetwork ? parseFloat(selectedNetwork.withdrawFee) : 0,
                        depositEnable: selectedNetwork ? selectedNetwork.depositEnable : false,
                        withdrawEnable: selectedNetwork ? selectedNetwork.withdrawEnable : false
                    };
                }).filter(item => item.depositEnable || item.withdrawEnable); // Hanya ambil yang salah satu deposit / withdraw aktif
    
                // Gabungkan hasil ke allFeeWD
                console.log("MEXC WALLET:",coinDepositWithdrawStatus);
                allFeeWD = [...allFeeWD, ...coinDepositWithdrawStatus];
                //checkAndSaveAllFeeWD();
    
                isMexcSuccess = true; // Tandai sukses
                toastr.info("SUKSES, CEK UPDATE WALLET MEXC");
                checkAllUpdatesCompleted();
            },
            error: function (xhr, status, error) {
                toastr.error('UPDATE WALLET MEXC GAGAL, MASALAH KONEKSI!!');
            }
        });
    }
    //fungsi cek FEE WD per TOKEN BYBIT  
    function CekfeeWDBYBIT() {
        const ApiKey = CONFIG_CEX.BYBIT.ApiKey;
        const apiSecret = CONFIG_CEX.BYBIT.ApiSecret;
        const chainTypeConfig = DTChain.CEXCHAIN.BYBIT.chainCEX; // Ambil konfigurasi chain
        
        const timestamp = Date.now().toString();
        const recvWindow = "5000";
        const dataToSign = timestamp + ApiKey + recvWindow;
        const signature = calculateSignature("BYBIT", apiSecret, dataToSign, "HmacSHA256");
    
        const apiUrl = "https://api.bybit.com/v5/asset/coin/query-info";
    
        $.ajax({    
            url: apiUrl,
            method: "GET",
            headers: {
                "X-BAPI-SIGN": signature,
                "X-BAPI-API-KEY": ApiKey,
                "X-BAPI-TIMESTAMP": timestamp,
                "X-BAPI-RECV-WINDOW": recvWindow,
            },
            success: function (data) {
                dataCoins = data.result.rows;
    
                // Filter berdasarkan chainType yang sesuai dengan konfigurasi di chainTypeConfig dan hanya ambil yang deposit atau withdraw enable
                const coinsWithNetwork = dataCoins.filter(function (item) {
                    return item.chains.some(function (network) {
                        return network.chainType === chainTypeConfig &&
                                (network.chainDeposit === '1' || network.chainWithdraw === '1');  // Salah satu harus aktif
                    });
                });
    
                const coinDepositWithdrawStatus = coinsWithNetwork.map(function (item) {
                    const Network = item.chains.find(function (network) {
                        return network.chainType === chainTypeConfig;
                    });
    
                    return {
                        cex: "BYBIT",
                        chain: DTChain.CEXCHAIN.BYBIT.chainCEX,
                        tokenName: item.coin,
                        scToken: Network.contractAddress,  // Tidak ada informasi contract address di BYBIT
                        feeWDs: Network ? Network.withdrawFee : 0,
                        depositEnable: Network ? (Network.chainDeposit === '1') : false,
                        withdrawEnable: Network ? (Network.chainWithdraw === '1') : false
                    };
                });

                console.log("BYBIT WALLET:",coinDepositWithdrawStatus);
                // Gabungkan hasil ke allFeeWD
                allFeeWD = allFeeWD.concat(coinDepositWithdrawStatus);
                //checkAndSaveAllFeeWD();
    
                isBybitSuccess = true; // Tandai sukses
                toastr.info("SUKSES, CEK UPDATE WALLET BYBIT");
                checkAllUpdatesCompleted();
                
            },
            error: function (xhr, status, error) {
                toastr.error('UPDATE WALLET BYBIT GAGAL, MASALAH KONEKSI!!');
            }
        });
    }
    //fungsi cek FEE WD per TOKEN OKX
    function CekfeeWDOKX() {
        const ApiKey = CONFIG_CEX.OKX.ApiKey;
        const apiSecret = CONFIG_CEX.OKX.ApiSecret;
        const passphrase = CONFIG_CEX.OKX.ApiPassphrase;
        const chainTypeConfig = DTChain.CEXCHAIN.OKX.chainCEX; // Ambil konfigurasi chain, misalnya 'USDT-TRC20'
    
        const timestamp = new Date().toISOString();
        const method = "GET";
        const queryString = "/api/v5/asset/currencies";
        const dataToSign = timestamp + method + queryString;
    
        const signature = calculateSignature("OKX", apiSecret, dataToSign, "BASE64");
    
        if (!signature) {
            toastr.error("Gagal menghitung signature OKX. Periksa konfigurasi.");
            return;
        }
    
        const apiUrl = "https://kirihaha.awokawok.workers.dev/?https://www.okx.com";
    
        const headers = {
            "OK-ACCESS-KEY": ApiKey,
            "OK-ACCESS-SIGN": signature,
            "OK-ACCESS-TIMESTAMP": timestamp,
            "OK-ACCESS-PASSPHRASE": passphrase,
        };
    
        // Lakukan request AJAX untuk mengambil data dari API
        $.ajax({
            url: apiUrl + queryString, 
            type: "GET",
            headers: headers,
            success: function (data) {
                if (!Array.isArray(data.data)) {
                    toastr.error("Data dari API OKX tidak valid.");
                    return;
                }
    
                // Filter data untuk chain yang berakhiran dengan 'TRC20'
                const coinsWithNetwork = data.data.filter(item => {
                    // Cek apakah chain berakhiran dengan 'TRC20' dan memiliki status deposit dan withdraw yang aktif
                    return item.chain.endsWith(chainTypeConfig) && item.canDep && item.canWd;
                });
    
                // Mapping data untuk mendapatkan informasi deposit, withdraw, dan fee
                const coinDepositWithdrawStatus = coinsWithNetwork.map(item => {
                    return {
                        cex: "OKX",
                        chain: DTChain.CEXCHAIN.OKX.chainCEX,
                        tokenName: item.ccy,                // Mata uang (misalnya: USDT)
                        scToken: item.ctAddr,               // Alamat kontrak (misalnya: TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t)
                        feeWDs: parseFloat(item.fee),  // Fee withdrawal (misalnya: 1.5)
                        depositEnable: item.canDep,    // Status deposit
                        withdrawEnable: item.canWd     // Status withdraw
                    };
                });
                console.log("OKX WALLET:",coinDepositWithdrawStatus);
                // Gabungkan hasil ke allFeeWD
                allFeeWD = allFeeWD.concat(coinDepositWithdrawStatus);
                //checkAndSaveAllFeeWD();
    
                isOkxSuccess = true; 
                checkAllUpdatesCompleted();
    
                toastr.info("SUKSES, CEK UPDATE WALLET OKX");
            },
            error: function (xhr, status, error) {
                toastr.error('UPDATE WALLET OKX GAGAL, MASALAH KONEKSI!!');
                console.error("Error response: ", xhr.responseText);
            }
        });
    }

    //fungsi download token
    $('#tokenCountALL').on('click', function () {
        // Ambil data dari localStorage
        const rawData = getFromLocalStorage("TOKEN_SCANNER", []);
        //const rawData = filteredData;
        if (!rawData || rawData.length === 0) {
            toastr.error('Data TOKEN tidak ditemukan...');
            return;
        }

        // Proses data ke format CSV
        const formattedData = rawData.map(item => ({
            cex: item.cex,
            symbol_in: item.symbol_in,
            sc_in: item.sc_in,
            des_in: item.des_in,
            withdrawToken: item.status ? "TRUE" : "FALSE",
            depositToken: item.status ? "TRUE" : "FALSE",
            symbol_out: item.symbol_out,
            sc_out: item.sc_out,
            des_out: item.des_out,
            withdrawPair: item.status ? "TRUE" : "FALSE",
            depositPair: item.status ? "TRUE" : "FALSE",
            status: item.status ? "TRUE" : "FALSE" ,
        }));

        // Buat header dan isi CSV
        const csvHeader = Object.keys(formattedData[0]).join(','); // Header CSV
        const csvRows = formattedData.map(row => Object.values(row).join(',')).join('\n'); // Gabungkan semua baris
        const csvContent = `${csvHeader}\n${csvRows}`; // Gabungkan header dan isi

        // Buat file Blob untuk diunduh
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        // Buat elemen <a> untuk download
        const a = document.createElement('a');
        // Hitung jumlah item yang statusnya true
        const countTrueStatus = rawData.filter(item => 
                item.status === true 
                /* && 
                item.depositPair === true && 
                item.withdrawToken === true && 
                item.depositToken === true && 
                item.withdrawPair === true
                */
        ).length;
   
        a.href = url;
        a.download = countTrueStatus+'_MULTIPAIR_V3_' + (Nama_Chain || 'UNKNOWN').toUpperCase() + '_TOKEN.csv'; // Pastikan Nama_Chain terdefinisi
        a.style.display = 'none';

        // Tambahkan tombol ke DOM dan klik
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });

    function setLastAction(action) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Bulan dimulai dari 0
        const year = now.getFullYear();

        const formattedTime = `${hours}:${minutes}:${seconds} | ${day}/${month}/${year}`;

        const lastAction = {
            time: formattedTime,
            action: action
        };

        saveToLocalStorage("HISTORY", lastAction);
        $("#infoAPP").html(`${lastAction.action} at ${lastAction.time}`);
    }
    
</script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.6.22/dist/js/uikit.min.js"></script>
</body>
</html>
